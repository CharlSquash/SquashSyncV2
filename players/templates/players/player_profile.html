{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ player.full_name }} - Player Profile{% endblock %}

{% block extra_head %}
<style>
    .rating-stars {
        color: #ffc107; /* Star color */
        font-size: 1.2rem;
    }
    .rating-stars .bi-star {
        color: var(--bs-secondary-bg);
    }
    .performance-card, .solo-log-card {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: .375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .performance-card .rating-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: .25rem 0;
    }
    .hidden-assessment, .hidden-note, .hidden-log {
        display: none;
    }
    /* Fix for Tom Select in Bootstrap 5 input groups if needed, though here it is standalone */
    .ts-control {
        border: 1px solid var(--bs-border-color);
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
    }
    .ts-dropdown {
        z-index: 10000 !important; /* Ensure it pops over other elements */
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                {% if player.photo %}
                    <img src="{{ player.photo.url }}" class="card-img-top" alt="{{ player.full_name }}">
                {% else %}
                    <img src="{% static 'images/default_avatar.png' %}" class="card-img-top" alt="Default Avatar">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ player.full_name }}</h5>
                    <p class="card-text">
                        {% if player.school %}
                            <strong>School:</strong> {{ player.school }}<br>
                        {% endif %}
                        <strong>Grade:</strong> {{ player.get_grade_display|default:"N/A" }}<br>
                        <strong>Groups:</strong> {{ player.active_groups|join:", " }}
                        {% if player.past_groups %}
                            <details class="mt-1">
                                <summary class="text-primary" style="cursor: pointer; font-size: 0.9em;">View Past Groups</summary>
                                <ul class="list-unstyled mb-0 ms-3 small text-muted">
                                    {% for group in player.past_groups %}
                                        <li>{{ group.name }} {% if group.year %}({{ group.year }}){% endif %}</li>
                                    {% endfor %}
                                </ul>
                            </details>
                        {% endif %}
                    </p>
                    {% if request.user.is_superuser %}
                    <a href="{% url 'admin:players_player_change' player.id %}" class="btn btn-primary">Edit Player</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">Attendance</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">Performance</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="assessments-tab" data-bs-toggle="tab" data-bs-target="#assessments" type="button" role="tab">Assessments</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="solo-practice-tab" data-bs-toggle="tab" data-bs-target="#solo-practice" type="button" role="tab">Solo Practice</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics" type="button" role="tab">Metrics</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="matches-tab" data-bs-toggle="tab" data-bs-target="#matches" type="button" role="tab">Matches</button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="attendance" role="tabpanel">
                    <div class="card shadow-sm mt-3">
                        <div class="card-header">{{ filter_title }}</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-5">
                                    <h2 class="card-title text-center display-4">{{ attendance_percentage }}%</h2>
                                    <p class="text-center text-muted">Attended {{ attended_sessions_count }} of {{ total_sessions_count }} sessions.</p>
                                    <hr>
                                    <h5>Attendance Discrepancy History</h5>
                                    <ul class="list-group list-group-flush">
                                        {% for item in discrepancy_history %}
                                        <li class="list-group-item">
                                            {{ item.session.session_date|date:"d M Y" }}:
                                            <span class="badge 
                                                {% if item.discrepancy_type == 'NO_SHOW' %}bg-danger
                                                {% elif item.discrepancy_type == 'UNEXPECTED' %}bg-warning text-dark
                                                {% else %}bg-secondary{% endif %}">
                                                {{ item.get_discrepancy_type_display }}
                                            </span>
                                        </li>
                                        {% empty %}
                                        <li class="list-group-item text-muted">No discrepancies recorded.</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <div class="col-md-7">
                                    <form method="get" class="p-3 border rounded">
                                        <div class="mb-3">
                                            <label for="{{ attendance_filter_form.school_group.id_for_label }}" class="form-label">{{ attendance_filter_form.school_group.label }}</label>
                                            {{ attendance_filter_form.school_group }}
                                        </div>
                                        <div class="mb-3">
                                            <label for="{{ attendance_filter_form.start_date.id_for_label }}" class="form-label">Start date</label>
                                            {{ attendance_filter_form.start_date }}
                                        </div>
                                        <div class="mb-3">
                                            <label for="{{ attendance_filter_form.end_date.id_for_label }}" class="form-label">End date</label>
                                            {{ attendance_filter_form.end_date }}
                                        </div>
                                        <button type="submit" class="btn btn-secondary w-100 mt-2">Apply Filter</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="performance" role="tabpanel">
                    <div class="mt-3">
                        {% if average_ratings %}
                            <div class="performance-card mb-4">
                                <h5>Overall Performance Average</h5>
                                <p class="text-muted small">Based on {{ average_ratings.effort_rating.count }} submitted assessment(s).</p>
                                {% for field, data in average_ratings.items %}
                                    <div class="rating-row">
                                        <strong>{{ data.label }}</strong>
                                        <span class="rating-stars">
                                            {% for i in "12345" %}
                                                <i class="bi {% if data.avg >= i|add:0 %}bi-star-fill{% else %}bi-star{% endif %}"></i>
                                            {% endfor %}
                                        </span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div id="assessments-list">
                            {% for assessment in assessments %}
                                <div class="performance-card {% if forloop.counter > 5 %}hidden-assessment{% endif %}">
                                    <h6 class="mb-1">Session on {{ assessment.session.session_date|date:"d M Y" }}</h6>
                                    <small class="text-muted">Assessed by: {{ assessment.submitted_by.coach_profile|default:assessment.submitted_by.username }}</small>
                                    <hr class="my-2">
                                    <div class="rating-row">
                                        <span>Effort</span>
                                        <span class="rating-stars">
                                            {% for i in "12345" %}<i class="bi {% if assessment.effort_rating >= i|add:0 %}bi-star-fill{% else %}bi-star{% endif %}"></i>{% endfor %}
                                        </span>
                                    </div>
                                    <div class="rating-row">
                                        <span>Focus</span>
                                        <span class="rating-stars">
                                            {% for i in "12345" %}<i class="bi {% if assessment.focus_rating >= i|add:0 %}bi-star-fill{% else %}bi-star{% endif %}"></i>{% endfor %}
                                        </span>
                                    </div>
                                    <div class="rating-row">
                                        <span>Resilience</span>
                                        <span class="rating-stars">
                                            {% for i in "12345" %}<i class="bi {% if assessment.resilience_rating >= i|add:0 %}bi-star-fill{% else %}bi-star{% endif %}"></i>{% endfor %}
                                        </span>
                                    </div>
                                    <div class="rating-row">
                                        <span>Composure</span>
                                        <span class="rating-stars">
                                            {% for i in "12345" %}<i class="bi {% if assessment.composure_rating >= i|add:0 %}bi-star-fill{% else %}bi-star{% endif %}"></i>{% endfor %}
                                        </span>
                                    </div>
                                    <div class="rating-row">
                                        <span>Decision Making</span>
                                        <span class="rating-stars">
                                            {% for i in "12345" %}<i class="bi {% if assessment.decision_making_rating >= i|add:0 %}bi-star-fill{% else %}bi-star{% endif %}"></i>{% endfor %}
                                        </span>
                                    </div>
                                </div>
                            {% empty %}
                                <p class="mt-3">No performance ratings found.</p>
                            {% endfor %}
                        </div>

                        {% if assessments|length > 5 %}
                            <div class="text-center mt-3">
                                <button id="show-more-assessments" class="btn btn-sm btn-outline-secondary">Show More</button>
                                <button id="show-less-assessments" class="btn btn-sm btn-outline-secondary" style="display: none;">Show Less</button>
                            </div>
                        {% endif %}
                    </div>
                </div>


                <div class="tab-pane fade" id="assessments" role="tabpanel">
                    <div id="assessment-notes-list" class="list-group mt-3">
                        {% for assessment in assessments %}
                            {% if assessment.coach_notes %}
                                <div class="list-group-item {% if forloop.counter > 5 %}hidden-note{% endif %}">
                                    <h5 class="mb-1">Session on {{ assessment.session.session_date|date:"d M Y" }}</h5>
                                    <p class="mb-1">{{ assessment.coach_notes|linebreaksbr }}</p>
                                    <small>Assessed by: {{ assessment.submitted_by.coach_profile|default:assessment.submitted_by.username }}</small>
                                </div>
                            {% endif %}
                        {% empty %}
                            <p class="mt-3">No assessments notes found.</p>
                        {% endfor %}
                    </div>

                    {% if assessments|length > 5 %}
                        <div class="text-center mt-3">
                            <button id="show-more-notes" class="btn btn-sm btn-outline-secondary">Show More</button>
                            <button id="show-less-notes" class="btn btn-sm btn-outline-secondary" style="display: none;">Show Less</button>
                        </div>
                    {% endif %}
                </div>
                
                <div class="tab-pane fade" id="solo-practice" role="tabpanel">
                    <div id="solo-logs-list" class="mt-3">
                        {% for log in solo_session_logs %}
                            <div class="solo-log-card {% if forloop.counter > 5 %}hidden-log{% endif %}">
                                <h6 class="mb-1">
                                    <strong>{{ log.routine.name|default:"Custom Session" }}</strong> on {{ log.completed_at|date:"d M Y" }}
                                </h6>
                                <hr class="my-2">
                                <div class="rating-row">
                                    <span>Difficulty</span>
                                    <span class="rating-stars">
                                        {% for i in "12345" %}<i class="bi {% if log.difficulty_rating >= i|add:0 %}bi-star-fill{% else %}bi-star{% endif %}"></i>{% endfor %}
                                    </span>
                                </div>
                                <div class="rating-row">
                                    <span>Likelihood to Repeat</span>
                                    <span class="rating-stars">
                                        {% for i in "12345" %}<i class="bi {% if log.likelihood_rating >= i|add:0 %}bi-star-fill{% else %}bi-star{% endif %}"></i>{% endfor %}
                                    </span>
                                </div>
                                {% if log.notes %}
                                    <div class="mt-2">
                                        <strong>Notes:</strong>
                                        <p class="mb-0">{{ log.notes|linebreaksbr }}</p>
                                    </div>
                                {% endif %}
                            </div>
                        {% empty %}
                            <p class="mt-3">No solo practice logs found.</p>
                        {% endfor %}
                    </div>

                    {% if solo_session_logs|length > 5 %}
                        <div class="text-center mt-3">
                            <button id="show-more-logs" class="btn btn-sm btn-outline-secondary">Show More</button>
                            <button id="show-less-logs" class="btn btn-sm btn-outline-secondary" style="display: none;">Show Less</button>
                        </div>
                    {% endif %}
                </div>

                <div class="tab-pane fade" id="metrics" role="tabpanel">
                    <div class="accordion mt-3" id="metricsAccordion">
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSprints">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSprints">Court Sprints</button>
                            </h2>
                            <div id="collapseSprints" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                <div class="accordion-body">
                                    <div style="height: 300px;">
                                        <canvas id="sprintChart"></canvas>
                                    </div>
                                    <hr>
                                    <h5>Add New Sprint Record</h5>
                                    <form method="post" action="{% url 'players:add_metric' player.id %}">
                                        {% csrf_token %}
                                        {{ sprint_form|crispy }}
                                        <button type="submit" name="add_sprint_record" class="btn btn-primary mt-2">Save Record</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingVolleys">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVolleys">Volleys</button>
                            </h2>
                            <div id="collapseVolleys" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                <div class="accordion-body">
                                    <div style="height: 300px;">
                                        <canvas id="volleyChart"></canvas>
                                    </div>
                                    <hr>
                                    <h5>Add New Volley Record</h5>
                                    <form method="post" action="{% url 'players:add_metric' player.id %}">
                                        {% csrf_token %}
                                        {{ volley_form|crispy }}
                                        <button type="submit" name="add_volley_record" class="btn btn-primary mt-2">Save Record</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingDrives">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDrives">Backwall Drives</button>
                            </h2>
                            <div id="collapseDrives" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                <div class="accordion-body">
                                    <div style="height: 300px;">
                                        <canvas id="driveChart"></canvas>
                                    </div>
                                    <hr>
                                    <h5>Add New Drive Record</h5>
                                    <form method="post" action="{% url 'players:add_metric' player.id %}">
                                        {% csrf_token %}
                                        {{ drive_form|crispy }}
                                        <button type="submit" name="add_drive_record" class="btn btn-primary mt-2">Save Record</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="matches" role="tabpanel">
                    <div class="accordion mt-3" id="matchesAccordion">
                        <div class="accordion-item">
                             <h2 class="accordion-header" id="headingMatches">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMatches">Match History</button>
                            </h2>
                            <div id="collapseMatches" class="accordion-collapse collapse" data-bs-parent="#matchesAccordion">
                                <div class="accordion-body">
                                    <ul class="list-group mt-3">
                                        {% for match in match_history %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>
                                                    {% if match.player.id == player.id %}
                                                        <span class="badge bg-success">Win</span>
                                                        vs {{ match.opponent.full_name|default:match.opponent_name }}
                                                        ({{ match.date|date:"d M Y" }}) -
                                                    {% else %}
                                                        <span class="badge bg-danger">Loss</span>
                                                        vs {{ match.player.full_name }}
                                                        ({{ match.date|date:"d M Y" }}) -
                                                    {% endif %}
                                                    <strong>{{ match.player_score_str }}</strong>
                                                    {% if match.sets_data %}
                                                        <span class="text-muted small ms-2">
                                                            ({% for set in match.sets_data %}{{ set.p1 }}-{{ set.p2 }}{% if not forloop.last %}, {% endif %}{% endfor %})
                                                        </span>
                                                    {% endif %}
                                                </span>
                                                {% if request.user.is_superuser or match.created_by == request.user %}
                                                <form action="{% url 'assessments:delete_match_result' match.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this match result?');">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="Delete Match Result"><i class="bi bi-trash"></i></button>
                                                </form>
                                                {% endif %}
                                            </li>
                                        {% empty %}
                                            <li class="list-group-item">No match results recorded.</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingAddMatch">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAddMatch">Add Match Result</button>
                            </h2>
                            <div id="collapseAddMatch" class="accordion-collapse collapse" data-bs-parent="#matchesAccordion">
                                <div class="accordion-body">
                                    <form method="post" action="{% url 'players:add_metric' player.id %}" id="add-match-form">
                                        {% csrf_token %}
                                        
                                        <!-- Winner Selection -->
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Who Won?</label>
                                            <div class="d-flex gap-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="winner" id="winner_me" value="me" checked>
                                                    <label class="form-check-label" for="winner_me">
                                                        {{ player.full_name }}
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="winner" id="winner_opponent" value="opponent">
                                                    <label class="form-check-label" for="winner_opponent">
                                                        Opponent
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Opponent Fields -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                {{ match_form.opponent|as_crispy_field }}
                                            </div>
                                            <div class="col-md-6" id="opponent-name-container">
                                                {{ match_form.opponent_name|as_crispy_field }}
                                            </div>
                                        </div>

                                        <!-- Dynamic Sets Section -->
                                        <div class="mb-3 p-3 bg-light rounded border">
                                            <label class="form-label fw-bold d-flex justify-content-between">
                                                <span>Set Scores</span>
                                                <span id="running-score" class="badge bg-primary rounded-pill">Current Score: 0 - 0</span>
                                            </label>
                                            
                                            <table class="table table-sm table-borderless mb-2">
                                                <thead>
                                                    <tr class="text-muted small text-center">
                                                        <th style="width: 40%">{{ player.full_name }}</th>
                                                        <th style="width: 40%">Opponent</th>
                                                        <th style="width: 20%"></th>
                                                    </tr>
                                                </thead>
                                                <tbody id="sets-container">
                                                    <!-- Dynamic Rows go here -->
                                                </tbody>
                                            </table>
                                            
                                            <button type="button" class="btn btn-sm btn-outline-secondary w-100 dashed-border" id="add-set-btn">
                                                <i class="bi bi-plus-circle"></i> Add Set
                                            </button>
                                        </div>

                                        <!-- Hidden processed fields -->
                                        {{ match_form.sets_data }}
                                        
                                        <!-- Other fields -->
                                        {{ match_form.date|as_crispy_field }}
                                        {{ match_form.is_competitive|as_crispy_field }}
                                        {{ match_form.match_notes|as_crispy_field }}
                                        
                                        <!-- Hidden Score String (Auto-calculated) -->
                                        <div class="d-none">
                                            {{ match_form.player_score_str }}
                                        </div>

                                        <button type="submit" name="add_match_result" class="btn btn-primary mt-2 w-100">Save Match Result</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {{ block.super }} {# This includes the Chart.js from base.html #}
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <script id="sprint-data" type="application/json">{{ sprint_records_json|safe }}</script>
    <script id="volley-data" type="application/json">{{ volley_records_json|safe }}</script>
    <script id="drive-data" type="application/json">{{ drive_records_json|safe }}</script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... (The JavaScript for charts and show/hide buttons remains the same) ...
            const chartOptions = {
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day' },
                        title: { display: true, text: 'Date' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Score' }
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            };

            const sprintCtx = document.getElementById('sprintChart');
            if (sprintCtx) {
                const sprintData = JSON.parse(document.getElementById('sprint-data').textContent);
                const datasets = {};
                sprintData.forEach(r => {
                    const label = r.duration_choice;
                    if (!datasets[label]) {
                        datasets[label] = { label: `Sprint (${label})`, data: [], tension: 0.1 };
                    }
                    datasets[label].data.push({ x: r.date_recorded, y: r.score });
                });
                new Chart(sprintCtx, { type: 'line', data: { datasets: Object.values(datasets) }, options: chartOptions });
            }

            const volleyCtx = document.getElementById('volleyChart');
            if (volleyCtx) {
                const volleyData = JSON.parse(document.getElementById('volley-data').textContent);
                const datasets = {};
                volleyData.forEach(r => {
                    const label = r.shot_type === 'FH' ? 'Forehand' : 'Backhand';
                    if (!datasets[label]) {
                        datasets[label] = { label: `Volley (${label})`, data: [], tension: 0.1 };
                    }
                    datasets[label].data.push({ x: r.date_recorded, y: r.consecutive_count });
                });
                new Chart(volleyCtx, { type: 'line', data: { datasets: Object.values(datasets) }, options: chartOptions });
            }

            const driveCtx = document.getElementById('driveChart');
            if (driveCtx) {
                const driveData = JSON.parse(document.getElementById('drive-data').textContent);
                const datasets = {};
                driveData.forEach(r => {
                    const label = r.shot_type === 'FH' ? 'Forehand' : 'Backhand';
                    if (!datasets[label]) {
                        datasets[label] = { label: `Drive (${label})`, data: [], tension: 0.1 };
                    }
                    datasets[label].data.push({ x: r.date_recorded, y: r.consecutive_count });
                });
                new Chart(driveCtx, { type: 'line', data: { datasets: Object.values(datasets) }, options: chartOptions });
            }
    
            // Show/hide assessments
            const showMoreBtn = document.getElementById('show-more-assessments');
            const showLessBtn = document.getElementById('show-less-assessments');
            const assessmentsList = document.getElementById('assessments-list');

            if (showMoreBtn) {
                showMoreBtn.addEventListener('click', () => {
                    assessmentsList.querySelectorAll('.hidden-assessment').forEach(el => {
                        el.style.display = 'block';
                    });
                    showMoreBtn.style.display = 'none';
                    showLessBtn.style.display = 'inline-block';
                });
            }

            if (showLessBtn) {
                showLessBtn.addEventListener('click', () => {
                    const allAssessments = assessmentsList.querySelectorAll('.performance-card');
                    allAssessments.forEach((el, index) => {
                        if (index >= 5) {
                            el.style.display = 'none';
                        }
                    });
                    showLessBtn.style.display = 'none';
                    showMoreBtn.style.display = 'inline-block';
                });
            }

            // Show/hide assessment notes
            const showMoreNotesBtn = document.getElementById('show-more-notes');
            const showLessNotesBtn = document.getElementById('show-less-notes');
            const assessmentNotesList = document.getElementById('assessment-notes-list');

            if (showMoreNotesBtn) {
                showMoreNotesBtn.addEventListener('click', () => {
                    assessmentNotesList.querySelectorAll('.hidden-note').forEach(el => {
                        el.style.display = 'block';
                    });
                    showMoreNotesBtn.style.display = 'none';
                    showLessNotesBtn.style.display = 'inline-block';
                });
            }

            if (showLessNotesBtn) {
                showLessNotesBtn.addEventListener('click', () => {
                    const allNotes = assessmentNotesList.querySelectorAll('.list-group-item');
                    allNotes.forEach((el, index) => {
                        if (index >= 5) {
                            el.style.display = 'none';
                        }
                    });
                    showLessNotesBtn.style.display = 'none';
                    showMoreNotesBtn.style.display = 'inline-block';
                });
            }

            // Show/hide solo logs
            const showMoreLogsBtn = document.getElementById('show-more-logs');
            const showLessLogsBtn = document.getElementById('show-less-logs');
            const soloLogsList = document.getElementById('solo-logs-list');

            if (showMoreLogsBtn) {
                showMoreLogsBtn.addEventListener('click', () => {
                    soloLogsList.querySelectorAll('.hidden-log').forEach(el => {
                        el.style.display = 'block';
                    });
                    showMoreLogsBtn.style.display = 'none';
                    showLessLogsBtn.style.display = 'inline-block';
                });
            }

            if (showLessLogsBtn) {
                showLessLogsBtn.addEventListener('click', () => {
                    const allLogs = soloLogsList.querySelectorAll('.solo-log-card');
                    allLogs.forEach((el, index) => {
                        if (index >= 5) {
                            el.style.display = 'none';
                        }
                    });
                    showLessLogsBtn.style.display = 'none';
                    showMoreLogsBtn.style.display = 'inline-block';
                });
            }

            // Initialize Tom Select for Opponent Dropdown
            // We check if the element exists first
            const opponentSelect = document.getElementById('id_opponent');
            const opponentNameInput = document.getElementById('id_opponent_name');
            // Helper to toggle visibility of the name field container (div.mb-3 usually)
            const toggleNameField = (hasValue) => {
                if (!opponentNameInput) return;
                const container = opponentNameInput.closest('div'); // The wrapping div for the form field
                if (container) {
                    container.style.display = hasValue ? 'none' : 'block';
                }
                // Optional: Clear the manual input if hiding it, to avoid confusion?
                // if (hasValue) opponentNameInput.value = ''; 
            };

            if (opponentSelect) {
                const ts = new TomSelect(opponentSelect, {
                    create: false,
                    sortField: {
                        field: "text",
                        direction: "asc"
                    },
                    placeholder: 'Type to search...',
                    onChange: function(value) {
                        toggleNameField(!!value);
                    }
                });
                
                // Initial check in case of reload with value
                toggleNameField(!!opponentSelect.value);
            }

            // --- Dynamic Sets Logic ---
            const setsContainer = document.getElementById('sets-container');
            const addSetBtn = document.getElementById('add-set-btn');
            const scoreLabel = document.getElementById('running-score');
            const setsDataInput = document.getElementById('id_sets_data');
            const form = document.getElementById('add-match-form');
            
            if (setsContainer && addSetBtn) {
                // Function to update the JSON field and running total
                const updateSetsData = () => {
                    const rows = setsContainer.querySelectorAll('tr');
                    const sets = [];
                    let p1Total = 0;
                    let p2Total = 0;

                    rows.forEach(row => {
                        const p1Input = row.querySelector('.p1-score');
                        const p2Input = row.querySelector('.p2-score');
                        
                        // Parse values
                        const p1Val = parseInt(p1Input.value) || 0;
                        const p2Val = parseInt(p2Input.value) || 0;
                        
                        // Only add if at least one side has a score (or both 0 if intentional, but usually typed)
                        // Actually, we want to capture whatever is typed.
                        sets.push({ p1: p1Val, p2: p2Val });

                        if (p1Val > p2Val) p1Total++;
                        if (p2Val > p1Val) p2Total++;
                    });

                    // Update JSON Input
                    setsDataInput.value = JSON.stringify(sets);
                    
                    // Update Label
                    scoreLabel.textContent = `Current Score: ${p1Total} - ${p2Total}`;
                };

                // Function to add a row
                const addRow = (p1 = '', p2 = '') => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <input type="number" class="form-control form-control-sm text-center p1-score" placeholder="0" value="${p1}" min="0">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm text-center p2-score" placeholder="0" value="${p2}" min="0">
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-link text-danger p-0 remove-set-btn"><i class="bi bi-x-circle"></i></button>
                        </td>
                    `;
                    setsContainer.appendChild(tr);

                    // Add listeners
                    const inputs = tr.querySelectorAll('input');
                    inputs.forEach(input => input.addEventListener('input', updateSetsData));
                    tr.querySelector('.remove-set-btn').addEventListener('click', () => {
                        tr.remove();
                        updateSetsData();
                    });
                };

                // Add initial row if empty
                if (setsContainer.children.length === 0) {
                    addRow();
                }

                addSetBtn.addEventListener('click', () => addRow());
                
                // If form fails and reloads, we might want to repopulate from setsDataInput.value
                // But simplified for now: just start fresh or relying on browser autocomplete.
                // ideally:
                const existingData = setsDataInput.value;
                if(existingData) {
                     try {
                        const parsed = JSON.parse(existingData);
                        if(Array.isArray(parsed) && parsed.length > 0) {
                             setsContainer.innerHTML = ''; // Clear default
                             parsed.forEach(s => addRow(s.p1, s.p2));
                             updateSetsData();
                        }
                     } catch(e) {}
                }
            }

        });
    </script>
{% endblock %}
