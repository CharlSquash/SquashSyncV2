{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Edit Match Result - {{ player.full_name }}{% endblock %}

{% block extra_head %}
<style>
    /* Fix for Tom Select in Bootstrap 5 */
    .ts-control {
        border: 1px solid var(--bs-border-color);
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
    }
    .ts-dropdown {
        z-index: 10000 !important;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Edit Match Result</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">Editing match for <strong>{{ player.full_name }}</strong></p>
                    
                    <form method="post" id="edit-match-form">
                        {% csrf_token %}
                        
                        <!-- Winner Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Who Won?</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="winner" id="winner_me" value="me" {% if form.initial.winner == 'me' %}checked{% endif %}>
                                    <label class="form-check-label" for="winner_me">
                                        {{ player.full_name }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="winner" id="winner_opponent" value="opponent" {% if form.initial.winner == 'opponent' %}checked{% endif %}>
                                    <label class="form-check-label" for="winner_opponent">
                                        Opponent
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Opponent Fields -->
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.opponent|as_crispy_field }}
                            </div>
                            <div class="col-md-6" id="opponent-name-container">
                                {{ form.opponent_name|as_crispy_field }}
                            </div>
                        </div>

                        <!-- Dynamic Sets Section -->
                        <div class="mb-3 p-3 bg-light rounded border">
                            <label class="form-label fw-bold d-flex justify-content-between">
                                <span>Set Scores ({{ player.full_name }} vs Opponent)</span>
                                <span id="running-score" class="badge bg-primary rounded-pill">Current Score: 0 - 0</span>
                            </label>
                            
                            <table class="table table-sm table-borderless mb-2">
                                <thead>
                                    <tr class="text-muted small text-center">
                                        <th style="width: 40%">{{ player.full_name }}</th>
                                        <th style="width: 40%">Opponent</th>
                                        <th style="width: 20%"></th>
                                    </tr>
                                </thead>
                                <tbody id="sets-container">
                                    <!-- Dynamic Rows go here -->
                                </tbody>
                            </table>
                            
                            <button type="button" class="btn btn-sm btn-outline-secondary w-100 dashed-border" id="add-set-btn">
                                <i class="bi bi-plus-circle"></i> Add Set
                            </button>
                        </div>

                        <!-- Hidden processed fields -->
                        {{ form.sets_data }}
                        
                        <!-- Other fields -->
                        {{ form.date|as_crispy_field }}
                        {{ form.is_competitive|as_crispy_field }}
                        {{ form.match_notes|as_crispy_field }}
                        
                        <!-- Hidden Score String (Auto-calculated) -->
                        <div class="d-none">
                            {{ form.player_score_str }}
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'players:player_profile' player.id %}" class="btn btn-outline-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Tom Select for Opponent Dropdown
            const opponentSelect = document.getElementById('id_opponent');
            const opponentNameInput = document.getElementById('id_opponent_name');
            
            const toggleNameField = (hasValue) => {
                if (!opponentNameInput) return;
                const container = opponentNameInput.closest('div'); 
                if (container) {
                    container.style.display = hasValue ? 'none' : 'block';
                }
            };

            if (opponentSelect) {
                const ts = new TomSelect(opponentSelect, {
                    create: false,
                    sortField: { field: "text", direction: "asc" },
                    placeholder: 'Type to search...',
                    onChange: function(value) {
                        toggleNameField(!!value);
                    }
                });
                toggleNameField(!!opponentSelect.value);
            }

            // --- Dynamic Sets Logic ---
            const setsContainer = document.getElementById('sets-container');
            const addSetBtn = document.getElementById('add-set-btn');
            const scoreLabel = document.getElementById('running-score');
            const setsDataInput = document.getElementById('id_sets_data');

            const updateSetsData = () => {
                const rows = setsContainer.querySelectorAll('tr');
                const sets = [];
                let p1Total = 0;
                let p2Total = 0;

                rows.forEach(row => {
                    const p1Input = row.querySelector('.p1-score');
                    const p2Input = row.querySelector('.p2-score');
                    
                    const p1Val = parseInt(p1Input.value) || 0;
                    const p2Val = parseInt(p2Input.value) || 0;
                    
                    // Allow typed values even if 0
                    sets.push({ p1: p1Val, p2: p2Val });

                    if (p1Val > p2Val) p1Total++;
                    if (p2Val > p1Val) p2Total++;
                });

                setsDataInput.value = JSON.stringify(sets);
                scoreLabel.textContent = `Current Score: ${p1Total} - ${p2Total}`;
            };

            const addRow = (p1 = '', p2 = '') => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="number" class="form-control form-control-sm text-center p1-score" placeholder="0" value="${p1}" min="0">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-center p2-score" placeholder="0" value="${p2}" min="0">
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-link text-danger p-0 remove-set-btn"><i class="bi bi-x-circle"></i></button>
                    </td>
                `;
                setsContainer.appendChild(tr);

                const inputs = tr.querySelectorAll('input');
                inputs.forEach(input => input.addEventListener('input', updateSetsData));
                tr.querySelector('.remove-set-btn').addEventListener('click', () => {
                    tr.remove();
                    updateSetsData();
                });
            };

            addSetBtn.addEventListener('click', () => addRow());

            // --- Pre-fill Data ---
            const existingData = setsDataInput.value;
            if(existingData) {
                 try {
                    const parsed = JSON.parse(existingData);
                    if(Array.isArray(parsed) && parsed.length > 0) {
                         setsContainer.innerHTML = ''; 
                         parsed.forEach(s => addRow(s.p1, s.p2));
                         updateSetsData();
                    } else {
                        // If empty array or invalid, add one empty row
                        addRow();
                    }
                 } catch(e) {
                     console.error("Error parsing sets data", e);
                     addRow();
                 }
            } else {
                addRow();
            }
        });
    </script>
{% endblock %}
