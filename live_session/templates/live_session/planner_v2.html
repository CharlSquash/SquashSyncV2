<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SquashSync Planner - Mobile Ready</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Configure Import Map for React & Lucide -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>

    <!-- 3. Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar to match the design */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 3px;
        }
        /* Mobile optimizations */
        body {
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile app feel */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    {{ players_json|json_script:"players-data" }}
    {{ drills_json|json_script:"drills-data" }}
    {{ current_plan_json|json_script:"current-plan-data" }}
    {% url 'scheduling:session_detail' session_id as session_url %}
    {{ session_url|json_script:"back-url" }}
    {% url 'live_session:create_custom_drill' as create_drill_url %}
    {{ create_drill_url|json_script:"create-drill-url" }}
    {% url 'scheduling:save_session_plan' session_id as save_plan_url %}
    {{ save_plan_url|json_script:"save-plan-url" }}
    {{ csrf_token|json_script:"csrf-token" }}
    {{ notes_json|json_script:"notes-data" }}
    {% url 'live_session:add_session_note' session_id as add_note_url %}
    {{ add_note_url|json_script:"add-note-url" }}

    <!-- 4. Your Application Code -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Play, Pause, SkipForward, SkipBack, Users, Youtube, Plus, Trash2, 
            Save, Layout, Clock, Activity, MonitorPlay, ArrowRight, ArrowLeft, RefreshCw, 
            Search, Grid, Copy, Check, List, Library, Info, X, Cloud, CloudLightning,
            Flame, Trophy, Target, Zap, Timer, Heart, Dumbbell, Footprints, Layers, Move,
            ChevronLeft, ChevronRight, MessageSquare, Coffee
        } from 'lucide-react';

        /**
         * Mock Data 
         */
        const SERVER_PLAYERS = JSON.parse(document.getElementById('players-data').textContent).map(p => ({
            ...p,
            name: `${p.first_name} ${p.last_name}`
        }));
        const SERVER_DRILLS = JSON.parse(document.getElementById('drills-data').textContent).map(d => ({
            ...d,
            defaultDuration: (d.duration_minutes || 10) * 60,
            type: d.category || 'General',
            difficulty: d.difficulty || 'All Levels'
        }));
        const CURRENT_PLAN = JSON.parse(document.getElementById('current-plan-data').textContent);
        const BACK_URL = JSON.parse(document.getElementById('back-url').textContent);
        const CREATE_DRILL_URL = JSON.parse(document.getElementById('create-drill-url').textContent);
        const SAVE_PLAN_URL = JSON.parse(document.getElementById('save-plan-url').textContent);
        const CSRF_TOKEN = JSON.parse(document.getElementById('csrf-token').textContent);
        const SERVER_NOTES = JSON.parse(document.getElementById('notes-data').textContent);
        const ADD_NOTE_URL = JSON.parse(document.getElementById('add-note-url').textContent);


        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        };

        const getCategoryStyle = (category, isRest) => {
            if (isRest) return { 
                icon: Coffee, 
                color: 'bg-amber-50', 
                border: 'border-amber-200', 
                accent: 'text-amber-500', 
                leftBorder: 'border-l-amber-400' 
            };

            switch (category) {
                case 'Warmups':
                    return { icon: Flame, color: 'bg-orange-50', border: 'border-orange-200', accent: 'text-orange-500', leftBorder: 'border-l-orange-500' };
                case 'Conditioning':
                case 'Fitness':
                    return { icon: Dumbbell, color: 'bg-emerald-50', border: 'border-emerald-200', accent: 'text-emerald-500', leftBorder: 'border-l-emerald-500' };
                case 'Hand-Eye Coordination':
                case 'Drills - Racketwork':
                case 'Feeding Drills':
                    return { icon: Target, color: 'bg-blue-50', border: 'border-blue-200', accent: 'text-blue-500', leftBorder: 'border-l-blue-500' };
                case 'Fun Games':
                case 'Condition Games':
                    return { icon: Trophy, color: 'bg-purple-50', border: 'border-purple-200', accent: 'text-purple-500', leftBorder: 'border-l-purple-500' };
                case 'Ghosting':
                case 'Movement':
                    return { icon: Footprints, color: 'bg-slate-100', border: 'border-slate-300', accent: 'text-slate-500', leftBorder: 'border-l-slate-500' };
                case 'Circuits (Score/Time)':
                    return { icon: Timer, color: 'bg-red-50', border: 'border-red-200', accent: 'text-red-500', leftBorder: 'border-l-red-500' };
                default:
                    return { icon: Activity, color: 'bg-white', border: 'border-slate-200', accent: 'text-slate-400', leftBorder: 'border-l-slate-500' };
            }
        };

        const getYouTubeId = (url) => {
            if (!url) return null;
            try {
                // Handle partial URLs or IDs
                if (!url.startsWith('http')) {
                    if (url.length === 11) return url; // It's just the ID
                    url = `https://${url}`;
                }

                const urlObj = new URL(url);
                
                // 1. Handle shortened URLs (youtu.be)
                if (urlObj.hostname.includes('youtu.be')) {
                    return urlObj.pathname.slice(1);
                }
                
                // 2. Handle all youtube.com domains (www, m, music, etc.)
                if (urlObj.hostname.includes('youtube.com')) {
                    // Check for standard 'v' parameter query (e.g. watch?v=ID)
                    if (urlObj.searchParams.has('v')) {
                        return urlObj.searchParams.get('v');
                    }
                    
                    // Check path-based formats
                    // Splits path to handle: /shorts/ID, /live/ID, /embed/ID, /v/ID
                    const pathSegments = urlObj.pathname.split('/').filter(Boolean);
                    if (pathSegments.length > 0) {
                        // If path is like /shorts/ID, the first segment is the type, second is ID
                        if (['shorts', 'live', 'embed', 'v'].includes(pathSegments[0])) {
                            return pathSegments[1];
                        }
                    }
                }
            } catch (e) {
                console.error("Invalid URL format:", url);
            }
            return null;
        };

        const CircularTimer = ({ duration, currentTime, isRest, size = "large" }) => {
            const radius = size === "large" ? 120 : 60;
            const stroke = size === "large" ? 12 : 6;
            const normalizedRadius = radius - stroke * 2;
            const circumference = normalizedRadius * 2 * Math.PI;
            const strokeDashoffset = circumference - (currentTime / duration) * circumference;
            const fontSize = size === "large" ? "text-6xl" : "text-2xl";
            const subTextSize = size === "large" ? "text-sm" : "text-[10px]";

            return (
                <div className="relative flex items-center justify-center">
                <svg height={radius * 2} width={radius * 2} className="transform -rotate-90">
                    <circle stroke={isRest ? "#f59e0b" : "#334155"} strokeWidth={stroke} fill="transparent" r={normalizedRadius} cx={radius} cy={radius} />
                    <circle stroke={isRest ? "#fbbf24" : "#10b981"} strokeWidth={stroke} strokeDasharray={circumference + ' ' + circumference} style={ { strokeDashoffset, transition: "stroke-dashoffset 0.5s linear" } } strokeLinecap="round" fill="transparent" r={normalizedRadius} cx={radius} cy={radius} />
                </svg>
                <div className="absolute flex flex-col items-center justify-center text-slate-100">
                    <span className={`${fontSize} font-bold font-mono tracking-tighter`}>{formatTime(currentTime)}</span>
                    <span className={`${subTextSize} font-semibold uppercase tracking-widest mt-1 ${isRest ? 'text-amber-400' : 'text-emerald-400'}`}>
                    {isRest ? 'Rest' : 'Active'}
                    </span>
                </div>
                </div>
            );
        };

        const CreateDrillModal = ({ onClose, onCreated }) => {
            const [localDrill, setLocalDrill] = useState({
                name: '',
                category: 'Conditioning',
                difficulty: 'Beginner',
                description: '',
                duration: 10,
                video_url: ''
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch(CREATE_DRILL_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': CSRF_TOKEN
                        },
                        body: JSON.stringify(localDrill)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        onCreated({
                            ...data.drill,
                            defaultDuration: (data.drill.duration_minutes || 10) * 60,
                            type: data.drill.category,
                            difficulty: data.drill.difficulty
                        });
                        onClose();
                    } else {
                        const err = await response.text();
                        console.error("Failed to create drill:", err);
                        alert("Failed to create drill. Check console.");
                    }
                } catch (error) {
                    console.error("Error creating drill:", error);
                    alert("Error creating drill.");
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-slate-800 text-lg">Create Custom Drill</h3>
                            <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full transition"><X className="w-5 h-5 text-slate-500" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <form id="create-drill-form" onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Drill Name</label>
                                    <input required type="text" value={localDrill.name} onChange={e => setLocalDrill({...localDrill, name: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="e.g., Forehand Drive Target" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">Category</label>
                                        <select value={localDrill.category} onChange={e => setLocalDrill({...localDrill, category: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">

                                            <option value="Conditioning">Conditioning</option>
                                            <option value="Warmups">Warmups</option>
                                            <option value="Hand-Eye Coordination">Hand-Eye Coordination</option>
                                            <option value="Fun Games">Fun Games</option>
                                            <option value="Ghosting">Ghosting</option>
                                            <option value="Drills - Racketwork">Drills - Racketwork</option>
                                            <option value="Feeding Drills">Feeding Drills</option>
                                            <option value="Condition Games">Condition Games</option>
                                            <option value="Fitness">Fitness</option>
                                            <option value="Movement">Movement</option>
                                            <option value="Circuits (Score/Time)">Circuits (Score/Time)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">Difficulty</label>
                                        <select value={localDrill.difficulty} onChange={e => setLocalDrill({...localDrill, difficulty: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                            <option value="Beginner">Beginner</option>
                                            <option value="Intermediate">Intermediate</option>
                                            <option value="Advanced">Advanced</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Duration (minutes)</label>
                                    <input type="number" min="1" value={localDrill.duration} onChange={e => setLocalDrill({...localDrill, duration: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Video URL (YouTube)</label>
                                    <input type="url" value={localDrill.video_url} onChange={e => setLocalDrill({...localDrill, video_url: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="https://youtube.com/..." />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Description</label>
                                    <textarea value={localDrill.description} onChange={e => setLocalDrill({...localDrill, description: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 min-h-[100px]" placeholder="Describe the drill instructions..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                             <button type="button" onClick={onClose} className="px-4 py-2 text-slate-600 font-bold hover:bg-slate-200 rounded-lg transition">Cancel</button>
                             <button type="submit" form="create-drill-form" className="px-6 py-2 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition shadow-sm">Create Drill</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NotesModal = ({ onClose, notes, onAddNote }) => {
            const [newNote, setNewNote] = useState('');
            const [localNotes, setLocalNotes] = useState(notes);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [localNotes]);

            // Sync with parent prop updates if any (though we manage locally mainly)
            useEffect(() => {
                setLocalNotes(notes);
            }, [notes]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!newNote.trim()) return;

                setIsSubmitting(true);
                try {
                    const response = await fetch(ADD_NOTE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': CSRF_TOKEN
                        },
                        body: JSON.stringify({ text: newNote })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'success') {
                            const updatedNotes = [data.note, ...localNotes]; // Add to top or bottom? UI preference. Let's do top for recent. 
                            // Actually, chat style usually has new at bottom.
                            // But for "notes", newest first is often better.
                            // Let's stick to newest-first (top) for list view.
                            onAddNote(data.note);
                            setNewNote('');
                        } else {
                            alert(data.message || 'Error adding note');
                        }
                    } else {
                        alert('Failed to save note');
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error saving note");
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                                <MessageSquare className="w-5 h-5 text-emerald-600" />
                                Session Notes
                            </h3>
                            <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full transition"><X className="w-5 h-5 text-slate-500" /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-50/50 space-y-3">
                            {localNotes.length === 0 ? (
                                <div className="text-center py-10 text-slate-400">
                                    <MessageSquare className="w-12 h-12 mx-auto mb-2 opacity-20" />
                                    <p className="text-sm">No notes yet. Add important details below.</p>
                                </div>
                            ) : (
                                localNotes.map(note => (
                                    <div key={note.id} className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                                        <div className="flex justify-between items-start mb-1">
                                            <span className="font-bold text-xs text-emerald-700 bg-emerald-50 px-2 py-0.5 rounded-full">{note.author_name}</span>
                                            <span className="text-[10px] text-slate-400 font-mono">{note.created_at_formatted}</span>
                                        </div>
                                        <p className="text-sm text-slate-700 whitespace-pre-wrap">{note.text}</p>
                                    </div>
                                ))
                            )}
                        </div>

                        <div className="p-4 bg-white border-t border-slate-100">
                             <form onSubmit={handleSubmit} className="flex flex-col gap-2">
                                <textarea 
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm resize-none"
                                    rows="3"
                                    placeholder="Type a note here (e.g., 'Group beginner specific', 'Court 1 net broken')..."
                                    value={newNote}
                                    onChange={e => setNewNote(e.target.value)}
                                ></textarea>
                                <div className="flex justify-end">
                                    <button 
                                        type="submit" 
                                        disabled={isSubmitting || !newNote.trim()}
                                        className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                    >
                                        {isSubmitting ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Plus className="w-4 h-4" />}
                                        Add Note
                                    </button>
                                </div>
                             </form>
                        </div>
                    </div>
                </div>
            );
        };

        const MobileDrillPicker = ({ onClose, onAdd, onCreate, availableDrills, formatTime }) => {
            const [search, setSearch] = useState('');
            const [cat, setCat] = useState('All');
            
            const filtered = availableDrills.filter(d => {
                const matchSearch = d.name.toLowerCase().includes(search.toLowerCase());
                const matchCat = cat === 'All' || d.type === cat;
                return matchSearch && matchCat;
            });

            return (
                <div className="fixed inset-0 z-50 bg-slate-50 flex flex-col animate-in slide-in-from-bottom duration-300">
                    {/* Header */}
                    <div className="bg-white px-4 py-3 border-b border-slate-200 shadow-sm flex items-center justify-between shrink-0">
                        <h2 className="font-bold text-slate-800 text-lg">Add Drill</h2>
                        <div className="flex items-center gap-2">
                            <button onClick={onCreate} className="text-emerald-600 font-bold text-sm bg-emerald-50 px-3 py-1.5 rounded-lg border border-emerald-100 hover:bg-emerald-100 transition flex items-center gap-1">
                                <Plus className="w-4 h-4" /> Create
                            </button>
                            <button onClick={onClose} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                    </div>
                    
                    {/* Search & Filter */}
                    <div className="p-4 bg-white border-b border-slate-100 space-y-3 shrink-0">
                        <div className="relative">
                            <Search className="w-5 h-5 absolute left-3 top-2.5 text-slate-400" />
                            <input 
                                type="text" 
                                placeholder="Search drills..." 
                                className="w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-xl text-base focus:ring-2 focus:ring-emerald-500 outline-none"
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                            />
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar -mx-4 px-4 pb-1">
                            {['All', 'Conditioning', 'Warmups', 'Fun Games', 'Drills - Racketwork', 'Movement'].map(c => (
                                <button 
                                    key={c} 
                                    onClick={() => setCat(c)}
                                    className={`whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition ${cat === c ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600'}`}
                                >
                                    {c}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* List */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {filtered.map(drill => (
                            <button 
                                key={drill.id}
                                onClick={() => { onAdd(drill); }}
                                className="w-full bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between active:scale-[0.98] transition-transform"
                            >
                                <div className="text-left">
                                    <h4 className="font-bold text-slate-800">{drill.name}</h4>
                                    <div className="flex items-center gap-2 mt-1">
                                        <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">{drill.type}</span>
                                        <span className="text-xs text-slate-400 flex items-center gap-1"><Clock className="w-3 h-3" /> {formatTime(drill.defaultDuration)}</span>
                                    </div>
                                </div>
                                <div className="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600">
                                    <Plus className="w-5 h-5" />
                                </div>
                            </button>
                        ))}
                        <div className="h-20"></div> {/* Spacer for bottom safety */}
                    </div>
                </div>
            );
        };
        
        const SaveTemplateModal = ({ onClose, onSave, planData, courtCount }) => {
            const [name, setName] = useState('');
            const [description, setDescription] = useState('');
            const [isPublic, setIsPublic] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                try {
                    const response = await fetch('/live-session/api/templates/save/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': CSRF_TOKEN
                        },
                        body: JSON.stringify({
                            name,
                            description,
                            is_public: isPublic,
                            court_count: courtCount,
                            plan_data: planData
                        })
                    });
                    
                    const data = await response.json();
                    if (data.status === 'success') {
                        onSave();
                        onClose();
                        // alert("Template saved successfully!"); // Removed per user request
                    } else {
                        alert(data.message || 'Failed to save template.');
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error saving template.");
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-slate-800 text-lg">Save as Template</h3>
                            <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full transition"><X className="w-5 h-5 text-slate-500" /></button>
                        </div>
                        <div className="p-6">
                            <form id="save-template-form" onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Template Name</label>
                                    <input required type="text" value={name} onChange={e => setName(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="e.g., Elite Squad Tuesday" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Description</label>
                                    <textarea value={description} onChange={e => setDescription(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 min-h-[80px]" placeholder="Brief description of the session plan..."></textarea>
                                </div>
                                {/* Checkbox removed to enforce private templates by default */}
                            </form>
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                             <button type="button" onClick={onClose} className="px-4 py-2 text-slate-600 font-bold hover:bg-slate-200 rounded-lg transition">Cancel</button>
                             <button type="submit" form="save-template-form" disabled={isSubmitting} className="px-6 py-2 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition shadow-sm disabled:opacity-50 flex items-center gap-2">
                                {isSubmitting ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
                                Save Template
                             </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoadTemplateModal = ({ onClose, onLoad }) => {
            const [templates, setTemplates] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchTemplates = async () => {
                    try {
                        const res = await fetch('/live-session/api/templates/list/');
                        const data = await res.json();
                        if (data.status === 'success') {
                            setTemplates(data.templates);
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchTemplates();
            }, []);

            const handleDelete = async (id, e) => {
                e.stopPropagation();
                if (!confirm("Are you sure you want to delete this template?")) return;
                
                try {
                    const res = await fetch(`/live-session/api/templates/delete/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': CSRF_TOKEN }
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        setTemplates(prev => prev.filter(t => t.id !== id));
                    } else {
                        alert(data.message);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error deleting template");
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-slate-800 text-lg">Load Template</h3>
                            <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full transition"><X className="w-5 h-5 text-slate-500" /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-50/50 space-y-3">
                            {loading ? (
                                <div className="text-center py-10 text-slate-400 flex flex-col items-center">
                                    <RefreshCw className="w-8 h-8 animate-spin mb-2" />
                                    Loading templates...
                                </div>
                            ) : templates.length === 0 ? (
                                <div className="text-center py-10 text-slate-400">
                                    <p>No templates found.</p>
                                </div>
                            ) : (
                                templates.map(t => (
                                    <button 
                                        key={t.id}
                                        onClick={() => { onLoad(t.plan_data); onClose(); }}
                                        className="w-full bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-emerald-400 hover:shadow-md transition text-left group relative"
                                    >
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h4 className="font-bold text-slate-800 flex items-center gap-2">
                                                    {t.name}
                                                    {t.court_count && <span className="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 font-mono">{t.court_count} Courts</span>}
                                                </h4>
                                                <p className="text-xs text-slate-500 mt-1 lines-clamp-2">{t.description || "No description"}</p>
                                                <div className="mt-2 text-[10px] text-slate-400 font-medium bg-slate-50 inline-block px-2 py-1 rounded">
                                                    Created by {t.created_by}
                                                </div>
                                            </div>
                                            {t.is_owner && (
                                                <div 
                                                    onClick={(e) => handleDelete(t.id, e)}
                                                    className="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-red-500 transition"
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                </div>
                                            )}
                                        </div>
                                    </button>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        const DrillItem = ({ drill, index, isRest, onRemove, onUpdateDuration, onUpdateName, isMaster, onInfo, onDropOnDrill }) => {
            const [isResizing, setIsResizing] = useState(false);
            const [isDragOver, setIsDragOver] = useState(false);
            const itemRef = useRef(null);
            
            // 1 min = 10px (previously 12). Min height 60px covers 6 mins.
            // This ensures drills > 6 mins start growing immediately.
            const height = Math.max(60, Math.round((drill.duration / 60) * 10)); 
            const isTall = height > 80;

            const styles = getCategoryStyle(drill.type, isRest);
            const WatermarkIcon = styles.icon;

            const handleMouseDown = (e) => {
                if (isMaster) return; 
                e.stopPropagation(); 
                e.preventDefault();
                setIsResizing(true);
                
                const startY = e.clientY;
                const startDuration = drill.duration;
                
                const handleMouseMove = (moveEvent) => {
                    const deltaY = moveEvent.clientY - startY;
                    const deltaMinutes = deltaY / 10; // Match scale factor
                    const newDurationSeconds = Math.max(60, startDuration + (deltaMinutes * 60));
                    onUpdateDuration(drill.uid, newDurationSeconds, drill.masterSourceId);
                };
                
                const handleMouseUp = () => {
                    setIsResizing(false);
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                    document.body.style.cursor = 'default';
                };
                
                document.body.style.cursor = 'ns-resize';
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);
            };

            const handleDragOver = (e) => {
                if (isMaster) return;
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(false);
            };

            const handleDrop = (e) => {
                if (isMaster) return;
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(false);
                
                try {
                    const data = JSON.parse(e.dataTransfer.getData('application/json') || '{}');
                    if (data.type === 'DRILL') {
                        onDropOnDrill(e, index, data, drill.uid); // Pass this drill's UID as target
                        return;
                    }
                } catch(e) {}
            };

            const itemStyle = { height: `${height}px` };
                
            return (
                <div 
                    ref={itemRef}
                    draggable={!isMaster && !isResizing}
                    onDragStart={(e) => {
                        e.dataTransfer.setData('application/json', JSON.stringify({ 
                            type: 'DRILL', 
                            drillUid: drill.uid, 
                            sourceCourtIndex: index 
                        }));
                        e.dataTransfer.effectAllowed = "move";
                    }}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                    style={itemStyle}
                    className={`relative flex flex-col justify-between rounded-lg shadow-sm border p-2 mb-2 transition-all select-none overflow-hidden 
                    ${styles.color} ${styles.border} border-l-4 ${styles.leftBorder}
                    ${isResizing ? 'ring-2 ring-emerald-400 z-20' : ''}
                    ${isDragOver ? 'border-t-4 border-t-emerald-500 scale-[1.02] shadow-md' : ''}`}
                >
                    {/* Watermark */}
                    <div className="absolute -right-4 -bottom-4 z-0 opacity-10 transform -rotate-12 pointer-events-none">
                        <WatermarkIcon className="w-24 h-24 text-slate-900" /> 
                    </div>

                    {/* Content */}
                    <div className={`relative z-10 flex flex-col h-full ${isTall ? 'justify-between' : 'justify-between'}`}>
                        
                        {/* Header Row: Title & Actions */}
                        <div className={`flex justify-between items-start w-full ${isTall ? 'absolute top-0 left-0 p-2 w-full' : ''}`}>
                             {/* If Short, title is here. If Tall, title is centered below. */}
                             {!isTall && (
                                <h4 className="font-bold text-slate-800 text-sm leading-tight line-clamp-2 pr-6">{drill.customName}</h4>
                             )}
                             {/* Spacer if not tall to push buttons right, or absolute buttons */}
                             <div className={`flex gap-1 shrink-0 ml-auto ${isTall ? '' : '-mr-1'}`}>
                                <button onClick={(e) => { e.stopPropagation(); onInfo(drill); }} className="text-slate-400 hover:text-blue-500 p-1 rounded-full hover:bg-black/5 transition" title="View Details">
                                    <Info className="w-3.5 h-3.5" />
                                </button>
                                {!isMaster && (
                                    <button onClick={(e) => { e.stopPropagation(); onRemove(drill.uid); }} className="text-slate-400 hover:text-red-500 p-1 rounded-full hover:bg-black/5 transition">
                                        <Trash2 className="w-3.5 h-3.5" />
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Centered Title for Tall Cards */}
                        {isTall && (
                            <div className="flex-1 flex items-center justify-center p-4">
                                <h4 className="font-bold text-slate-800 text-lg text-center leading-tight drop-shadow-sm">{drill.customName}</h4>
                            </div>
                        )}

                        {/* Footer Row: Type & Duration */}
                         <div className={`flex items-end justify-between text-xs text-slate-500 gap-2 mt-auto w-full ${isTall ? 'absolute bottom-0 left-0 p-2' : ''}`}>
                            <span className="uppercase tracking-wider font-bold truncate flex-1 text-left opacity-70" title={drill.type}>{drill.type}</span>
                            <div className="flex items-center gap-1 bg-white/60 backdrop-blur-sm px-1.5 py-0.5 rounded shrink-0 border border-black/5 shadow-sm">
                                <Clock className="w-3.5 h-3.5" />
                                {!isMaster ? (
                                    <input 
                                        type="number" 
                                        className="w-8 bg-transparent text-center focus:outline-none font-mono font-bold text-slate-700 p-0 text-xs"
                                        value={Math.round(drill.duration / 60)} 
                                        onChange={(e) => onUpdateDuration(drill.uid, Math.max(0.5, parseFloat(e.target.value)) * 60, drill.masterSourceId)}
                                        onClick={(e) => e.stopPropagation()}
                                        onMouseDown={(e) => e.stopPropagation()} 
                                    /> 
                                ) : (
                                    <span className="font-mono font-bold text-slate-700">{Math.round(drill.duration / 60)}</span>
                                )}
                                <span className="text-[10px]">m</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* Resize Handle */}
                    {!isMaster && (
                        <div 
                            className="absolute bottom-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-black/10 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity z-20"
                            onMouseDown={handleMouseDown}
                        >
                            <div className="w-8 h-0.5 bg-slate-400 rounded-full"></div>
                        </div>
                    )}
                </div>
            );
        };

        const CourtColumn = ({ courtIndex, courtName, drills, players, onDropPlayer, onRemovePlayer, onAddDrill, onRemoveDrill, onUpdateDrill, isMaster, onDropDrill, onDragPlayerStart, onDrillInfo }) => {
            const [isdragOver, setIsDragOver] = useState(false);

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragOver(true);
            };

            const handleDragLeave = () => setIsDragOver(false);

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                
                try {
                    const data = JSON.parse(e.dataTransfer.getData('application/json') || '{}');
                    if (data.type === 'DRILL') {
                        onDropDrill(e, courtIndex, data);
                        return;
                    }
                } catch(e) {}
                
                onDropPlayer(e, courtIndex);
            };

            return (
                <div 
                    className={`flex flex-col h-full bg-slate-50 border-r border-slate-200 last:border-r-0 flex-1 min-w-[300px] ${isdragOver ? 'bg-indigo-50/50' : ''}`}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                >
                    {/* Header */}
                    <div className="p-3 border-b border-slate-200 bg-white sticky top-0 z-10">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                <span className="bg-slate-800 text-white text-xs px-2 py-0.5 rounded uppercase tracking-wider">{courtName}</span>
                                <span className="text-xs text-slate-400 font-normal">{drills.length} drills</span>
                            </h3>
                            <button onClick={onAddDrill} className="p-1 hover:bg-slate-100 rounded text-emerald-600 transition" title="Add Drill">
                                <Plus className="w-4 h-4" />
                            </button>
                        </div>

                        {/* Player/Group Drop Zone */}
                        <div className="min-h-[40px] border border-dashed border-slate-300 rounded-lg bg-slate-50 p-1 flex flex-wrap gap-1 content-start transition-colors hover:border-emerald-400 hover:bg-emerald-50/30">
                            {players.length === 0 ? (
                                <div className="w-full text-center py-2 text-[10px] text-slate-400 uppercase tracking-wide font-medium">Drop Players Here</div>
                            ) : (
                                players.map((p, idx) => (
                                    <span key={p.id} draggable onDragStart={(e) => onDragPlayerStart(e, p, courtIndex, idx)} className="text-xs font-bold text-slate-700 bg-white px-2 py-1 rounded shadow-sm border border-slate-200 cursor-grab active:cursor-grabbing flex items-center gap-1 group">
                                        {p.name}
                                        <button onClick={(e) => { e.stopPropagation(); onRemovePlayer(courtIndex, idx); }} className="text-slate-300 hover:text-red-500 hidden group-hover:block"><X className="w-3 h-3"/></button>
                                    </span>
                                ))
                            )}
                        </div>
                    </div>

                    {/* Body - Drills List */}
                    <div className="flex-1 overflow-y-auto p-2 custom-scrollbar">
                         {drills.length === 0 ? (
                             <div className="h-32 flex items-center justify-center text-slate-400 text-xs italic">No drills yet</div>
                         ) : (
                             drills.map((drill, idx) => (
                            <DrillItem 
                                    key={drill.uid} 
                                    drill={drill} 
                                    index={courtIndex} // Pass court index for source info
                                    isRest={drill.isRest}
                                    onRemove={onRemoveDrill}
                                    onUpdateDuration={onUpdateDrill}
                                    isMaster={isMaster}
                                    onInfo={onDrillInfo}
                                    onDropOnDrill={onDropDrill}
                                 />
                             ))
                         )}
                         <button onClick={onAddDrill} className="w-full py-2 mt-2 border border-dashed border-slate-300 rounded text-slate-400 text-xs font-bold hover:bg-slate-50 hover:text-emerald-600 transition flex items-center justify-center gap-1">
                            <Plus className="w-3 h-3" /> Add Drill
                         </button>
                    </div>
                    
                    {/* Footer Summary */}
                    <div className="p-2 border-t border-slate-200 bg-slate-50 text-xs font-mono text-slate-500 text-center">
                        Total: {Math.round(drills.reduce((acc, d) => acc + d.duration, 0) / 60)}m
                    </div>
                </div>
            );
        };

        function SquashSyncPlanner() {
            // App State
            const [view, setView] = useState('planning');
            
            // Mobile UI State
            const [activeMobileTab, setActiveMobileTab] = useState('plan'); // 'players' | 'plan' | 'drills'
            
            // Data State
            const [availablePlayers] = useState(SERVER_PLAYERS);
            const [availableDrills, setAvailableDrills] = useState(SERVER_DRILLS);
            const [showCreateDrillModal, setShowCreateDrillModal] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');
            const [expandedDrillId, setExpandedDrillId] = useState(null); // For Quick Preview
            const [isLibraryExpanded, setIsLibraryExpanded] = useState(false);
            const [showMobileDrillPicker, setShowMobileDrillPicker] = useState(false);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            
            // Template Modals State
            const [showSaveTemplateModal, setShowSaveTemplateModal] = useState(false);
            const [showLoadTemplateModal, setShowLoadTemplateModal] = useState(false);
            
            // Notes State
            const [showNotesModal, setShowNotesModal] = useState(false);
            const [notes, setNotes] = useState(SERVER_NOTES || []);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);
            
            // Initial Load Logic
            const [numCourts, setNumCourts] = useState(() => {
                if (CURRENT_PLAN && CURRENT_PLAN.numCourts) return Number(CURRENT_PLAN.numCourts);
                if (CURRENT_PLAN && CURRENT_PLAN.courtPlans) return CURRENT_PLAN.courtPlans.length;
                return 3;
            });
            const [groups, setGroups] = useState(() => {
                let initialGroups = [];
                if (CURRENT_PLAN && CURRENT_PLAN.groups) initialGroups = CURRENT_PLAN.groups;
                // Pad with empty arrays if needed to match numCourts (default 3 if not yet known, or use numCourts state logic)
                const targetLen = (CURRENT_PLAN && CURRENT_PLAN.numCourts) ? Number(CURRENT_PLAN.numCourts) : 3;
                while(initialGroups.length < targetLen) initialGroups.push([]);
                return initialGroups;
            });
            const [courtPlans, setCourtPlans] = useState(() => {
                if (CURRENT_PLAN && CURRENT_PLAN.courtPlans) return CURRENT_PLAN.courtPlans;
                return [ [], [], [] ]; // Default if nothing
            });
            const [masterSequence, setMasterSequence] = useState([]); // Master Plan Staging

            const [planningTab, setPlanningTab] = useState('all');
            const [saveStatus, setSaveStatus] = useState('saved'); // 'saved', 'saving', 'error'
            
            // Live Player State
            const [isPlaying, setIsPlaying] = useState(false);
            const [liveCourtView, setLiveCourtView] = useState('all'); 
            const [courtStates, setCourtStates] = useState([]);
            const [selectedDrill, setSelectedDrill] = useState(null);
            
            // Drag and Drop State
            const [draggedPlayer, setDraggedPlayer] = useState(null);
            const [dragOverGroup, setDragOverGroup] = useState(null);

            const timerRef = useRef(null);
            const saveTimeoutRef = useRef(null);
            const initialLoadRef = useRef(true);

            useEffect(() => {
                // Ensure array size matches numCourts if numCourts changed manually
                if (courtPlans.length !== numCourts) {
                    setCourtPlans(prev => {
                        const newPlans = [...prev];
                        while(newPlans.length < numCourts) newPlans.push([]);
                        while(newPlans.length > numCourts) newPlans.pop();
                        return newPlans;
                    });
                }
                setCourtStates(prev => {
                    const newStates = [...prev];
                    while(newStates.length < numCourts) newStates.push({ currentBlockIndex: 0, timeLeft: 0 });
                    while(newStates.length > numCourts) newStates.pop();
                    return newStates;
                });
                setGroups(prev => {
                    const newGroups = [...prev];
                    while(newGroups.length < numCourts) newGroups.push([]);
                    while(newGroups.length > numCourts) newGroups.pop();
                    return newGroups;
                });
            }, [numCourts]);

            // Auto-Save Effect
            useEffect(() => {
                if (initialLoadRef.current) {
                    initialLoadRef.current = false;
                    return;
                }

                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                
                setSaveStatus('saving');
                
                saveTimeoutRef.current = setTimeout(async () => {
                    try {
                        const payload = {
                            numCourts,
                            courtPlans,
                            groups
                        };
                        
                        const response = await fetch(SAVE_PLAN_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': CSRF_TOKEN
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            setSaveStatus('saved');
                        } else {
                            console.error("Save failed");
                            setSaveStatus('error');
                        }
                    } catch (e) {
                         console.error("Save error:", e);
                         setSaveStatus('error');
                    }
                }, 2000); // 2 second debounce

                return () => clearTimeout(saveTimeoutRef.current);
            }, [courtPlans, numCourts, groups]);

            const autoGroupPlayers = () => {
                const shuffled = [...availablePlayers].sort(() => 0.5 - Math.random());
                const newGroups = Array.from({ length: numCourts }, () => []);
                shuffled.forEach((player, index) => {
                    const groupIndex = index % numCourts;
                    newGroups[groupIndex].push(player);
                });
                setGroups(newGroups);
            };

            const getTargetCourts = () => planningTab === 'all' ? Array.from({ length: numCourts }, (_, i) => i) : [planningTab];

            const addDrillToPlan = (drill) => {
                if (planningTab === 'all') {
                    // 1. Add to Master Sequence
                    const masterBlock = {
                        ...drill,
                        uid: Math.random().toString(36).substr(2, 9),
                        customName: drill.name,
                        duration: drill.defaultDuration,
                        isRest: false
                    };
                    setMasterSequence(prev => [...prev, masterBlock]);

                    // 2. Propagate to All Courts
                    const newPlans = [...courtPlans];
                    newPlans.forEach((_, courtIdx) => {
                        const courtCopy = {
                            ...masterBlock,
                            uid: Math.random().toString(36).substr(2, 9),
                            masterSourceId: masterBlock.uid
                        };
                        newPlans[courtIdx] = [...newPlans[courtIdx], courtCopy];
                    });
                    setCourtPlans(newPlans);

                } else {
                    // Add only to specific court
                    const newPlans = [...courtPlans];
                    newPlans[planningTab] = [...newPlans[planningTab], { 
                        ...drill, 
                        uid: Math.random().toString(36).substr(2, 9),
                        customName: drill.name,
                        duration: drill.defaultDuration,
                        isRest: false
                    }];
                    setCourtPlans(newPlans);
                }

                // On mobile, switch back to plan view after adding to see the result
                if (window.innerWidth < 768) {
                    setActiveMobileTab('plan');
                }
            };

            const addRestPeriod = () => {
                if (planningTab === 'all') {
                    // 1. Add to Master Sequence
                    const masterBlock = {
                        uid: Math.random().toString(36).substr(2, 9),
                        name: "Water Break / Rotation",
                        customName: "Water Break",
                        type: "Rest",
                        duration: 60,
                        isRest: true,
                        videoId: null
                    };
                    setMasterSequence(prev => [...prev, masterBlock]);

                    // 2. Propagate to All Courts
                    const newPlans = [...courtPlans];
                    newPlans.forEach((_, courtIdx) => {
                         const courtCopy = {
                            ...masterBlock,
                            uid: Math.random().toString(36).substr(2, 9),
                            masterSourceId: masterBlock.uid
                        };
                        newPlans[courtIdx] = [...newPlans[courtIdx], courtCopy];
                    });
                    setCourtPlans(newPlans);
                } else {
                    const newPlans = [...courtPlans];
                    newPlans[planningTab] = [...newPlans[planningTab], {
                        uid: Math.random().toString(36).substr(2, 9),
                        name: "Water Break / Rotation",
                        customName: "Water Break",
                        type: "Rest",
                        duration: 60,
                        isRest: true,
                        videoId: null
                    }];
                    setCourtPlans(newPlans);
                }
            };

            const removeBlock = (courtIndex, blockUid, isCourtSpecific = false) => {
                if (planningTab === 'all' && !isCourtSpecific) { 
                    // 1. Remove from Master Sequence
                    // Filter masterSequence using blockUid as the master UID
                    setMasterSequence(prev => prev.filter(b => b.uid !== blockUid));

                    // 2. Remove from All Courts where masterSourceId matches
                    const newPlans = [...courtPlans];
                    newPlans.forEach((plan, cIdx) => {
                        newPlans[cIdx] = plan.filter(item => item.masterSourceId !== blockUid);
                    });
                    setCourtPlans(newPlans);
                } else {
                    const newPlans = [...courtPlans];
                    newPlans[courtIndex] = newPlans[courtIndex].filter(item => item.uid !== blockUid);
                    setCourtPlans(newPlans);
                }
            };

            const updateDuration = (courtIndex, blockUid, newDuration, masterSourceId) => {
                const duration = parseInt(newDuration) || 0;
                
                if (planningTab === 'all') {
                    // Use masterSourceId if available to find the master block, otherwise use blockUid (if it is a master block)
                    const targetMasterUid = masterSourceId || blockUid;

                    // 1. Update Master Sequence
                    setMasterSequence(prev => prev.map(b => b.uid === targetMasterUid ? { ...b, duration } : b));

                    // 2. Update All Courts
                    const newPlans = [...courtPlans];
                    newPlans.forEach((plan, cIdx) => {
                         newPlans[cIdx] = plan.map(item => (item.masterSourceId === targetMasterUid || item.uid === targetMasterUid) ? { ...item, duration } : item);
                    });
                    setCourtPlans(newPlans);

                } else {
                    const newPlans = [...courtPlans];
                    newPlans[courtIndex] = newPlans[courtIndex].map(item => item.uid === blockUid ? { ...item, duration } : item);
                    setCourtPlans(newPlans);
                }
            };

            const handleTemplateLoaded = (loadedPlanData) => {
                // Determine if loaded plan is object (full plan) or array (simple list of drills)
                // Our API saves 'plan_data' which is the courtPlans array usually, or an object with groups etc.
                // Let's assume it saves the courtPlans structure.
                
                let newCourtPlans = [];
                if (Array.isArray(loadedPlanData)) {
                    // It's likely courtPlans array
                    newCourtPlans = loadedPlanData;
                } else if (loadedPlanData.courtPlans) {
                    newCourtPlans = loadedPlanData.courtPlans;
                } else {
                    console.error("Unknown template format", loadedPlanData);
                    return;
                }

                // If court counts differ, we might need to adjust.
                // For now, simple replacement or filling.
                // Let's replace current plans with loaded plans, up to current numCourts.
                
                const adaptedPlans = Array.from({ length: numCourts }).map((_, i) => {
                    return newCourtPlans[i] || []; // Use loaded plan or empty if not enough courts
                });
                
                setCourtPlans(adaptedPlans);
                // Also reset master sequence? 
                // If template didn't have master sequence specific data, maybe clear it or try to derive.
                // For now, clear master
                setMasterSequence([]);
                
                // If template had groups/players, maybe load them?
                // Usually templates are just drills. Players are per session.
                // So we keep current groups.
                
                // alert("Template loaded successfully."); // Removed per user request
            };

            const startSession = () => {
                const initialStates = courtPlans.map(plan => ({
                    currentBlockIndex: 0,
                    timeLeft: plan.length > 0 ? plan[0].duration : 0,
                    isFinished: plan.length === 0
                }));
                setCourtStates(initialStates);
                setLiveCourtView('all');
                setView('live');
                setIsPlaying(false);
            };

            const togglePlay = () => setIsPlaying(!isPlaying);

            const skipAll = (direction) => {
                setCourtStates(prevStates => prevStates.map((state, idx) => {
                    const plan = courtPlans[idx];
                    let newIndex = state.currentBlockIndex + direction;
                    if (newIndex < 0) newIndex = 0;
                    if (newIndex >= plan.length) return { ...state, isFinished: true, timeLeft: 0 };
                    return { ...state, currentBlockIndex: newIndex, timeLeft: plan[newIndex].duration, isFinished: false };
                }));
                setIsPlaying(false);
            };

            const clearAll = () => {
                if (window.confirm("Are you sure you want to clear the entire session plan? This will remove all drills from all courts.")) {
                    const emptyPlans = Array.from({ length: numCourts }, () => []);
                    setCourtPlans(emptyPlans);
                    setMasterSequence([]);
                }
            };

            // Drag and Drop Handlers
            const handleDragStart = (e, player, sourceGroupIndex, sourcePlayerIndex) => {
                setDraggedPlayer({ player, sourceGroupIndex, sourcePlayerIndex });
                e.dataTransfer.effectAllowed = "move";
                // Transparent drag image or default
            };

            const handleDragOver = (e, groupIndex) => {
                e.preventDefault();
                if (draggedPlayer && draggedPlayer.sourceGroupIndex !== groupIndex) {
                    setDragOverGroup(groupIndex);
                    e.dataTransfer.dropEffect = "move";
                }
            };

            const handleDragLeave = (e) => {
                setDragOverGroup(null);
            };

            const handleDrop = (e, targetGroupIndex) => {
                e.preventDefault();
                setDragOverGroup(null);
                
                if (!draggedPlayer) return;
                const { player, sourceGroupIndex, sourcePlayerIndex } = draggedPlayer;

                if (sourceGroupIndex === targetGroupIndex) return;

                const newGroups = [...groups];
                
                // Remove from source
                // Remove from source if it was in a group
                if (sourceGroupIndex > -1) {
                    newGroups[sourceGroupIndex] = newGroups[sourceGroupIndex].filter((_, i) => i !== sourcePlayerIndex);
                }
                
                // Add to target
                newGroups[targetGroupIndex] = [...newGroups[targetGroupIndex], player];
                
                setGroups(newGroups);
                setDraggedPlayer(null);
            };

            const handleDropDrill = (e, targetCourtIndex, data, targetDrillUid = null) => {
                e.preventDefault();
                const { drillUid, sourceCourtIndex } = data;
                
                // Allow same-court reordering now
                // if (sourceCourtIndex === targetCourtIndex) { ... } // Removed restriction

                const isCopy = e.ctrlKey || e.metaKey; // Support Ctrl or Command (Mac)

                // Move from Source to Target
                const newPlans = [...courtPlans];
                
                // Find drill in source
                const drillToMove = newPlans[sourceCourtIndex].find(d => d.uid === drillUid);
                if (!drillToMove) return;

                if (!isCopy) {
                    // Remove from source
                    newPlans[sourceCourtIndex] = newPlans[sourceCourtIndex].filter(d => d.uid !== drillUid);
                }
                
                // Add to target
                // If copying, we MUST generate a new UID to avoid key conflicts
                const drillToAdd = isCopy ? { ...drillToMove, uid: Date.now() + Math.random().toString(36).substr(2, 9) } : drillToMove;
                
                // If dropping on a specific drill (targetDrillUid), insert before it
                if (targetDrillUid) {
                    const targetIndex = newPlans[targetCourtIndex].findIndex(d => d.uid === targetDrillUid);
                    if (targetIndex !== -1) {
                         newPlans[targetCourtIndex].splice(targetIndex, 0, drillToAdd);
                    } else {
                         // Fallback to push
                         newPlans[targetCourtIndex].push(drillToAdd);
                    }
                } else {
                    // Append to end
                    newPlans[targetCourtIndex].push(drillToAdd);
                }
                
                setCourtPlans(newPlans);
            };

            useEffect(() => {
                if (isPlaying) {
                    timerRef.current = setInterval(() => {
                        setCourtStates(prevStates => prevStates.map((state, idx) => {
                            if (state.isFinished || state.timeLeft <= 0) {
                                const plan = courtPlans[idx];
                                if (state.timeLeft <= 0 && !state.isFinished) {
                                    const nextIndex = state.currentBlockIndex + 1;
                                    if (nextIndex < plan.length) return { ...state, currentBlockIndex: nextIndex, timeLeft: plan[nextIndex].duration };
                                    else return { ...state, isFinished: true, timeLeft: 0 };
                                }
                                return state;
                            }
                            return { ...state, timeLeft: state.timeLeft - 1 };
                        }));
                    }, 1000);
                }
                return () => clearInterval(timerRef.current);
            }, [isPlaying, courtPlans]);

            const planToRender = planningTab === 'all' ? masterSequence : courtPlans[planningTab];
            const activeCourtColor = planningTab === 'all' ? 'border-emerald-500' : 'border-blue-500';

            // --- LIVE VIEW REMAINS LARGELY UNTOUCHED BUT RESPONSIVE ---
            if (view === 'live') {
                const isMasterView = liveCourtView === 'all';
                const focusedCourtIdx = isMasterView ? 0 : liveCourtView;
                const focusedState = courtStates[focusedCourtIdx];
                const focusedPlan = courtPlans[focusedCourtIdx];
                const currentBlock = focusedPlan?.[focusedState.currentBlockIndex];
                const totalBlocks = courtPlans.reduce((acc, p) => acc + p.length, 0);
                const completedBlocks = courtStates.reduce((acc, s) => acc + s.currentBlockIndex, 0);
                const progressPercent = totalBlocks > 0 ? (completedBlocks / totalBlocks) * 100 : 0;

                return (
                    <div className="flex flex-col h-screen bg-slate-900 text-white font-sans overflow-hidden">
                        <div className="h-16 bg-slate-800 flex items-center justify-between px-4 md:px-6 border-b border-slate-700">
                            <div className="flex items-center space-x-2 md:space-x-4">
                                <button onClick={() => setView('planning')} className="p-2 hover:bg-slate-700 rounded-full transition"><ArrowRight className="w-5 h-5 transform rotate-180 text-slate-400" /></button>
                                <h1 className="text-lg md:text-xl font-bold tracking-tight text-slate-100">SquashSync <span className="text-emerald-500">Live</span></h1>
                                <div className="hidden md:flex ml-8 bg-slate-900 rounded-lg p-1 border border-slate-700">
                                    <button onClick={() => setLiveCourtView('all')} className={`px-3 py-1 text-xs font-bold rounded-md transition ${isMasterView ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}>MASTER</button>
                                    {Array.from({ length: numCourts }).map((_, idx) => (
                                        <button key={idx} onClick={() => setLiveCourtView(idx)} className={`px-3 py-1 text-xs font-bold rounded-md transition ${liveCourtView === idx ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}>C{idx + 1}</button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex items-center space-x-2 md:space-x-4">
                                <div className="hidden md:block h-2 w-32 bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-emerald-500 transition-all duration-500" style={ { width: `${progressPercent}%` } }></div></div>
                                <button onClick={togglePlay} className={`p-2 rounded-full ${isPlaying ? 'bg-amber-500' : 'bg-emerald-500'}`}>{isPlaying ? <Pause className="w-4 h-4 text-white" /> : <Play className="w-4 h-4 text-white" />}</button>
                            </div>
                        </div>

                        {/* Mobile View Selector for Live Mode */}
                        <div className="md:hidden flex overflow-x-auto p-2 bg-slate-800 border-b border-slate-700 space-x-2">
                             <button onClick={() => setLiveCourtView('all')} className={`whitespace-nowrap px-3 py-1 text-xs font-bold rounded-md transition ${isMasterView ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 bg-slate-900'}`}>MASTER</button>
                             {Array.from({ length: numCourts }).map((_, idx) => (
                                <button key={idx} onClick={() => setLiveCourtView(idx)} className={`whitespace-nowrap px-3 py-1 text-xs font-bold rounded-md transition ${liveCourtView === idx ? 'bg-blue-600 text-white shadow' : 'text-slate-400 bg-slate-900'}`}>C{idx + 1}</button>
                            ))}
                        </div>

                        {isMasterView && (
                            <div className="flex-1 overflow-y-auto p-4 md:p-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                                    {courtPlans.map((plan, idx) => {
                                        const state = courtStates[idx];
                                        const block = plan[state.currentBlockIndex];
                                        const finished = state.isFinished;
                                        return (
                                            <div key={idx} className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden flex flex-col shadow-lg min-h-[250px]">
                                                <div className="bg-slate-750 p-3 border-b border-slate-700 flex justify-between items-center">
                                                    <h3 className="font-bold text-slate-200">Court {idx + 1}</h3>
                                                    <div className="flex items-center gap-2 flex-wrap">
                                                        {groups[idx]?.map(p => <span key={p.id} className="text-xs bg-slate-700 px-2 py-0.5 rounded text-slate-300">{p.name.split(' ')[0]}</span>)}
                                                    </div>
                                                </div>
                                                <div className="p-4 flex flex-col items-center justify-center flex-1">
                                                    {finished ? (
                                                        <div className="text-center"><Check className="w-12 h-12 text-emerald-500 mx-auto mb-2" /><span className="text-slate-400 font-bold">Session Complete</span></div>
                                                    ) : block ? (
                                                        <>
                                                            <CircularTimer duration={block.duration} currentTime={state.timeLeft} isRest={block.isRest} size="small" />
                                                            <div className="mt-4 text-center"><h4 className="text-lg md:text-xl font-bold text-white leading-tight mb-1">{block.customName}</h4><p className="text-xs text-slate-400 uppercase tracking-wider">{block.type}</p></div>
                                                        </>
                                                    ) : <span className="text-slate-500">No Plan</span>}
                                                </div>
                                                <div className="bg-slate-900/50 p-3 text-xs text-slate-500 flex justify-between items-center border-t border-slate-700"><span>Next:</span><span className="text-slate-300 font-medium truncate ml-2 max-w-[120px]">{plan[state.currentBlockIndex + 1]?.customName || "Finish"}</span></div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {!isMasterView && currentBlock && (
                            <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
                                <div className="flex-1 flex flex-col items-center justify-center p-4 md:p-8 border-b md:border-b-0 md:border-r border-slate-800 bg-gradient-to-br from-slate-900 to-slate-800 relative">
                                    <div className="absolute top-4 left-4 flex items-center gap-3">
                                        <div className="bg-blue-600 text-white font-bold text-lg md:text-xl px-3 py-1 md:px-4 md:py-2 rounded-lg shadow-lg">C{parseInt(liveCourtView) + 1}</div>
                                        <div className="flex flex-col hidden md:flex"><span className="text-xs text-slate-400 uppercase font-bold">Players</span><span className="text-sm text-slate-200">{groups[liveCourtView]?.map(p => p.name).join(', ')}</span></div>
                                    </div>
                                    <div className="mb-6 md:mb-8 text-center z-10 mt-12 md:mt-0">
                                        <span className={`inline-block px-3 py-1 rounded-full text-xs md:text-sm font-bold mb-4 ${currentBlock.isRest ? 'bg-amber-500/20 text-amber-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{currentBlock.isRest ? 'REST PERIOD' : 'DRILL IN PROGRESS'}</span>
                                        <h2 className="text-4xl md:text-7xl font-black text-white leading-tight max-w-2xl mx-auto">{currentBlock.customName}</h2>
                                    </div>
                                    <CircularTimer duration={currentBlock.duration} currentTime={focusedState.timeLeft} isRest={currentBlock.isRest} />
                                    <div className="mt-8 flex gap-4">
                                        <button onClick={() => skipAll(-1)} className="p-3 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-400"><SkipBack /></button>
                                        <button onClick={() => skipAll(1)} className="p-3 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-400"><SkipForward /></button>
                                    </div>
                                </div>
                                <div className="h-1/3 md:h-auto md:w-1/3 bg-slate-900 p-4 md:p-6 flex flex-col border-l border-slate-800 overflow-y-auto">
                                    <div className="hidden md:block aspect-video bg-black rounded-xl overflow-hidden shadow-2xl border border-slate-700 relative mb-6">
                                        {(() => {
                                            const vidId = getYouTubeId(currentBlock.video_url);
                                            if (vidId) {
                                                return (
                                                    <iframe 
                                                        className="w-full h-full" 
                                                        src={`https://www.youtube.com/embed/${vidId}?origin=${encodeURIComponent(window.location.origin)}&rel=0&enablejsapi=1`} 
                                                        title="Drill Video"
                                                        frameBorder="0" 
                                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                                        referrerPolicy="strict-origin-when-cross-origin"
                                                        allowFullScreen
                                                    ></iframe>
                                                );
                                            } else {
                                                return (
                                                    <div className="w-full h-full flex items-center justify-center bg-slate-800 text-slate-500">
                                                        {currentBlock.video_url ? <span className="text-xs">Invalid Video URL</span> : <Activity className="w-12 h-12 opacity-50" />}
                                                    </div>
                                                );
                                            }
                                        })()}
                                    </div>
                                    <h3 className="text-slate-500 font-bold uppercase text-xs tracking-wider mb-4 sticky top-0 bg-slate-900 py-2">Current Session Plan</h3>
                                    <div className="space-y-2">
                                        {focusedPlan.map((block, idx) => {
                                            const isActive = idx === focusedState.currentBlockIndex;
                                            const isPast = idx < focusedState.currentBlockIndex;
                                            return (
                                                <div key={idx} className={`p-3 rounded-lg border transition-all ${isActive ? 'bg-slate-800 border-emerald-500 shadow-md' : isPast ? 'bg-slate-900 border-slate-800 opacity-40' : 'bg-slate-900 border-slate-700'}`}>
                                                    <div className="flex justify-between items-center">
                                                        <span className={`font-bold text-sm md:text-base ${isActive ? 'text-white' : 'text-slate-400'}`}>{block.customName}</span>
                                                        <span className="text-xs font-mono text-slate-500">{formatTime(block.duration)}</span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // --- PLANNING MODE (MOBILE OPTIMIZED) ---
            return (
                <div className="h-screen bg-slate-50 text-slate-900 font-sans flex flex-col overflow-hidden">
                    <header className="bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between shadow-sm z-20 shrink-0">
                        <div className="flex items-center gap-2 md:gap-3">
                            <a href={BACK_URL} className="p-1 -ml-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-full transition" title="Back to Session">
                                <ArrowLeft className="w-5 h-5 md:w-6 md:h-6" />
                            </a>
                            {/* Mobile: Compact Logo */}
                            <div className="md:hidden font-bold text-slate-800 text-lg flex items-center gap-2">
                                Planner
                            </div>
                            {/* Desktop: Full Logo */}
                            <div className="hidden md:flex items-center gap-3">
                                <div className="bg-emerald-600 p-2 rounded-lg"><Activity className="w-6 h-6 text-white" /></div>
                                <div><h1 className="text-xl font-bold text-slate-800 leading-tight">SquashSync</h1><p className="text-xs text-slate-500">Coach Dashboard</p></div>
                            </div>
                        </div>

                        {/* Top Right Actions */}
                        <div className="flex items-center gap-2">
                             <button 
                                onClick={() => setShowNotesModal(true)}
                                className="relative p-2 text-slate-500 hover:bg-slate-100 rounded-full transition group"
                                title="Session Notes"
                            >
                                <MessageSquare className="w-6 h-6" />
                                {notes.length > 0 && (
                                    <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-emerald-500 rounded-full border-2 border-white"></span>
                                )}
                            </button>
                            <button 
                                onClick={clearAll}
                                className="md:hidden p-2 text-red-500 hover:bg-red-50 rounded-full transition"
                                title="Clear All"
                            >
                                <Trash2 className="w-6 h-6" />
                            </button>
                        </div>

                        {/* Mobile Box: Court Selector + Go Live */}
                        <div className="md:hidden flex items-center gap-2">
                            {/* Dropdown Court Selector */}
                            <div className="relative">
                                <select 
                                    value={planningTab} 
                                    onChange={(e) => setPlanningTab(e.target.value === 'all' ? 'all' : parseInt(e.target.value))}
                                    className="appearance-none pl-2 pr-7 py-1.5 bg-slate-100 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 max-w-[110px] truncate"
                                >
                                    <option value="all">Master Plan</option>
                                    {Array.from({ length: numCourts }).map((_, i) => (
                                        <option key={i} value={i}>Court {i + 1}</option>
                                    ))}
                                </select>
                                <ChevronRight className="w-3 h-3 text-slate-400 absolute right-2 top-1/2 -translate-y-1/2 rotate-90 pointer-events-none" />
                            </div>

                            <button onClick={startSession} className="bg-emerald-600 text-white p-1.5 rounded-full shadow-md active:bg-emerald-700 flex-shrink-0">
                                <MonitorPlay className="w-4 h-4" />
                            </button>
                        </div>

                        {/* Desktop Controls */}
                        <div className="hidden md:flex items-center gap-6">
                            <div className="flex items-center gap-2 text-xs font-bold uppercase tracking-wider">
                                {saveStatus === 'saving' && <span className="text-slate-400 flex items-center gap-1"><RefreshCw className="w-3 h-3 animate-spin"/> Saving...</span>}
                                {saveStatus === 'saved' && <span className="text-emerald-500 flex items-center gap-1"><Cloud className="w-3 h-3"/> Saved</span>}
                                {saveStatus === 'error' && <span className="text-red-500 flex items-center gap-1"><CloudLightning className="w-3 h-3"/> Error</span>}
                            </div>
                            <div className="flex items-center gap-2 bg-slate-50 px-3 rounded-lg border border-slate-200">
                                <Grid className="w-4 h-4 text-slate-400" />
                                <span className="text-sm text-slate-600 font-medium">Courts:</span>
                                <select value={numCourts} onChange={(e) => setNumCourts(parseInt(e.target.value))} className="bg-transparent text-sm font-bold text-slate-800 focus:outline-none cursor-pointer py-1.5">{[1, 2, 3, 4, 5, 6].map(n => <option key={n} value={n}>{n}</option>)}</select>
                            </div>
                            <button onClick={startSession} className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg font-medium transition shadow-sm hover:shadow-md"><MonitorPlay className="w-4 h-4" /> Start Live Session</button>
                        </div>
                    </header>
                    
                    <main className="flex-1 flex overflow-hidden relative">
                        {/* LEFT SIDEBAR: Players & Groups - MOBILE ONLY */}
                        {isMobile && activeMobileTab === 'players' && (
                            <aside className="w-full absolute z-20 bg-white flex flex-col overflow-y-auto h-full">
                                <div className="p-4 border-b border-slate-100 flex-shrink-0">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                            <Users className="w-4 h-4" /> Players
                                        </h2>
                                        <span className="text-xs bg-slate-100 px-2 py-1 rounded-full text-slate-600">
                                            {availablePlayers.filter(p => !groups.flat().some(gp => gp.id === p.id)).length} Unassigned
                                        </span>
                                    </div>
                                    <button onClick={autoGroupPlayers} className="w-full mb-2 flex items-center justify-center gap-2 text-xs font-bold bg-indigo-50 text-indigo-700 py-2 rounded-md hover:bg-indigo-100 transition border border-indigo-200">
                                        <RefreshCw className="w-3 h-3" /> Auto-Assign All
                                    </button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Unassigned</h3>
                                    {availablePlayers.filter(p => !groups.flat().some(gp => gp.id === p.id)).map((p, idx) => (
                                        <div 
                                            key={p.id}
                                            draggable
                                            onDragStart={(e) => {
                                                setDraggedPlayer({ player: p, sourceGroupIndex: -1, sourcePlayerIndex: idx });
                                                e.dataTransfer.effectAllowed = "move";
                                            }}
                                            className="bg-white border border-slate-200 rounded-lg p-2 shadow-sm hover:border-emerald-400 hover:shadow-md cursor-grab active:cursor-grabbing flex items-center gap-2"
                                        >
                                            <div className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">
                                                {p.name.charAt(0)}
                                            </div>
                                            <span className="text-sm font-medium text-slate-700 truncate">{p.name}</span>
                                        </div>
                                    ))}
                                    {availablePlayers.filter(p => !groups.flat().some(gp => gp.id === p.id)).length === 0 && (
                                        <div className="text-center py-8 text-slate-400 text-xs italic">
                                            All players assigned.
                                        </div>
                                    )}
                                </div>
                            </aside>
                        )}
                        
                        {/* CENTER: Plan Timeline (Desktop Grid / Mobile List) */}
                        { (!isMobile || activeMobileTab === 'plan') && (
                        <div className="flex-1 bg-slate-50/50 flex flex-col overflow-hidden w-full relative">
                            {/* THE BENCH (Desktop Top Bar) */}
                            {!isMobile && (
                                <div className="bg-white px-6 py-2 border-b border-slate-200 flex items-center gap-4 shrink-0 overflow-x-auto custom-scrollbar min-h-[50px]">
                                    <div className="flex items-center gap-2 text-slate-500 font-bold text-xs uppercase tracking-wider shrink-0 mr-2 border-r border-slate-100 pr-4">
                                        <Users className="w-4 h-4" /> Bench
                                        <span className="bg-slate-100 text-slate-600 px-1.5 rounded-full">{availablePlayers.filter(p => !groups.flat().some(gp => gp.id === p.id)).length}</span>
                                    </div>
                                    {availablePlayers.filter(p => !groups.flat().some(gp => gp.id === p.id)).map((p, idx) => (
                                        <div 
                                            key={p.id}
                                            draggable
                                            onDragStart={(e) => {
                                                setDraggedPlayer({ player: p, sourceGroupIndex: -1, sourcePlayerIndex: idx });
                                                e.dataTransfer.effectAllowed = "move";
                                            }}
                                            className="flex items-center gap-2 bg-white border border-slate-200 hover:border-emerald-400 hover:shadow-sm px-2 py-1 rounded-full cursor-grab active:cursor-grabbing transition shrink-0"
                                        >
                                            <div className="w-5 h-5 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-500">
                                                {p.name.charAt(0)}
                                            </div>
                                            <span className="text-xs font-bold text-slate-700">{p.name}</span>
                                        </div>
                                    ))}
                                    <button onClick={autoGroupPlayers} className="ml-auto flex items-center gap-1 text-[10px] font-bold uppercase tracking-wider text-indigo-600 hover:text-indigo-700 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-md transition shrink-0">
                                        <RefreshCw className="w-3 h-3" /> Auto-Assign
                                    </button>
                                </div>
                            )}

                            {/* Desktop: Grid View Header */}
                            <div className="hidden md:flex bg-white px-6 py-4 border-b border-slate-200 justify-between items-center shrink-0">
                                <div>
                                    <h2 className="text-xl font-bold text-slate-800">Session Plan</h2>
                                    <p className="text-slate-500 text-sm">Drag players and drills to organize.</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowNotesModal(true)} className="flex items-center gap-2 text-sm font-bold text-slate-600 hover:text-emerald-600 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200 transition"><MessageSquare className="w-4 h-4" /> Notes</button>
                                    <button onClick={() => setShowLoadTemplateModal(true)} className="flex items-center gap-2 text-sm font-bold text-slate-600 hover:text-slate-900 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200 transition">Load Template</button>
                                    <button onClick={() => setShowSaveTemplateModal(true)} className="flex items-center gap-2 text-sm font-bold text-emerald-600 hover:text-emerald-700 bg-emerald-50 px-3 py-2 rounded-lg border border-emerald-200 transition"><Save className="w-4 h-4" /> Save Template</button>
                                    <button onClick={addRestPeriod} className="flex items-center gap-2 text-sm font-bold text-amber-700 hover:text-amber-800 bg-amber-50 px-3 py-2 rounded-lg border border-amber-200 transition"><Clock className="w-4 h-4" /> Add Rest All</button>
                                    <button onClick={clearAll} className="flex items-center gap-2 text-sm font-bold text-red-600 hover:text-red-700 bg-red-50 px-3 py-2 rounded-lg border border-red-200 transition"><Trash2 className="w-4 h-4" /> Clear All</button>
                                </div>
                            </div>
                            
                            {/* Mobile Tabs (Hidden on Desktop) */}
                            <div className="md:hidden bg-white px-6 pt-4 border-b border-slate-200 gap-2 shrink-0 flex overflow-x-auto">
                                <button onClick={() => setPlanningTab('all')} className={`px-4 py-2 text-sm font-bold border-b-2 transition ${planningTab === 'all' ? 'border-emerald-500 text-emerald-700 bg-emerald-50/50' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>Master</button>
                                {Array.from({ length: numCourts }).map((_, idx) => <button key={idx} onClick={() => setPlanningTab(idx)} className={`px-4 py-2 text-sm font-bold border-b-2 transition ${planningTab === idx ? 'border-blue-500 text-blue-700 bg-blue-50/50' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>Court {idx + 1}</button>)}
                            </div>
                            
                            {/* Desktop GRID Layout */}
                            <div className="hidden md:flex flex-1 overflow-x-auto overflow-y-hidden bg-slate-100/50">
                                <div className={`flex flex-1 h-full ${numCourts === 1 ? 'max-w-4xl mx-auto border-x border-slate-200 shadow-sm' : ''}`}>
                                {Array.from({ length: numCourts }).map((_, i) => (
                                    <CourtColumn 
                                        key={i}
                                        courtIndex={i}
                                        courtName={`Court ${i + 1}`}
                                        drills={courtPlans[i] || []}
                                        players={groups[i] || []}
                                        onDropPlayer={handleDrop}
                                        onDragPlayerStart={handleDragStart}
                                        onDropDrill={handleDropDrill}
                                        onDrillInfo={setSelectedDrill}
                                        onRemovePlayer={(cIdx, pIdx) => {
                                            const newGroups = [...groups];
                                            newGroups[cIdx] = newGroups[cIdx].filter((_, idx) => idx !== pIdx);
                                            setGroups(newGroups);
                                        }}
                                        onAddDrill={() => {
                                            setPlanningTab(i);
                                            setIsLibraryExpanded(true);
                                        }}
                                        onRemoveDrill={(uid) => removeBlock(i, uid, true)}
                                        onUpdateDrill={(uid, dur, masterId) => updateDuration(i, uid, dur, masterId)}
                                        isMaster={false}
                                    />
                                ))}
                                </div>
                            </div>

                            {/* Mobile List Layout (Original) */}
                            <div className="md:hidden flex-1 overflow-y-auto px-4 pb-32 custom-scrollbar relative bg-white">
                                <div className="py-4">
                                     <div className="flex justify-between items-end mb-4">
                                        <div>
                                            <h2 className="text-xl font-bold text-slate-800">{planningTab === 'all' ? "Master Session Plan" : `Court ${planningTab + 1} Plan`}</h2>
                                            <p className="text-slate-500 text-xs mt-1">{planningTab === 'all' ? "Applies to all courts." : "Custom plan."}</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setShowLoadTemplateModal(true)} className="text-xs text-slate-600 px-3 py-2 bg-slate-50 border rounded">Load</button>
                                            <button onClick={addRestPeriod} className="text-xs text-amber-700 px-3 py-2 bg-amber-50 border border-amber-200 rounded flex gap-1"><Clock className="w-3 h-3" /> Rest</button>
                                        </div>
                                    </div>
                                    
                                    {!planToRender || planToRender.length === 0 ? (
                                        <div className="h-48 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center text-slate-400 bg-slate-50">
                                            <Layout className="w-10 h-10 mb-3 opacity-50" />
                                            <p className="text-center px-4">No drills planned.</p>
                                            <button onClick={() => setShowMobileDrillPicker(true)} className="mt-4 text-emerald-600 font-bold text-sm bg-white px-4 py-2 rounded border border-emerald-200 shadow-sm">Add Drill</button>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {planToRender.map((block, index) => (
                                                <div key={block.uid} className={`bg-white rounded-lg shadow-sm border p-3 transition-all ${block.isRest ? 'bg-amber-50 border-amber-100' : 'bg-white border-slate-200'} ${activeCourtColor}`}>
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="flex items-center gap-2">
                                                            <span className="w-6 h-6 flex items-center justify-center rounded-full bg-slate-200 text-xs font-bold text-slate-600">{index + 1}</span>
                                                            <button onClick={() => setSelectedDrill(block)} className="text-slate-400 hover:text-blue-500"><Info className="w-4 h-4" /></button>
                                                            <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${block.isRest ? 'bg-amber-100 text-amber-700' : 'bg-emerald-50 text-emerald-700'}`}>{block.type}</span>
                                                        </div>
                                                        <button onClick={() => removeBlock(planningTab === 'all' ? 0 : planningTab, block.uid)} className="p-2 text-slate-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                                                    </div>
                                                    <div className="mb-2">
                                                        <input type="text" value={block.customName} onChange={(e) => { if (planningTab !== 'all') { const newPlans = [...courtPlans]; newPlans[planningTab][index].customName = e.target.value; setCourtPlans(newPlans); } }} disabled={planningTab === 'all'} className="w-full bg-transparent font-medium text-slate-700 text-sm focus:outline-none focus:underline disabled:text-slate-500 truncate" />
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <Clock className="w-3 h-3 text-slate-400" />
                                                        <input type="number" step="0.5" min="0.5" value={block.duration / 60} onChange={(e) => updateDuration(planningTab === 'all' ? 0 : planningTab, block.uid, Math.round(parseFloat(e.target.value) * 60))} className="w-16 p-1 text-sm border border-slate-300 rounded text-center focus:outline-none" />
                                                        <span className="text-xs text-slate-400">min</span>
                                                    </div>
                                                </div>
                                            ))}
                                            <button onClick={() => setShowMobileDrillPicker(true)} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 font-bold flex items-center justify-center gap-2 hover:bg-slate-50 transition"><Plus className="w-5 h-5" /> Add New Drill</button>
                                            <div className="mt-4 p-4 text-right text-sm font-medium text-slate-500">Total: <span className="text-slate-900 font-bold">{formatTime(planToRender.reduce((acc, curr) => acc + curr.duration, 0))}</span></div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        )}

                        {/* RIGHT: Drill Library */}
                        <aside className={`hidden md:flex absolute inset-0 bg-white z-10 ${isLibraryExpanded ? 'md:absolute md:left-auto md:right-0 md:w-3/4 md:shadow-2xl border-l-2' : (numCourts <= 3 ? 'md:relative md:w-[450px] lg:w-[550px] border-l' : 'md:relative md:w-72 border-l')} border-slate-200 flex-col transition-all duration-300 group/sidebar`}>
                            {/* Toggle Button - Desktop Only */}
                            <button 
                                onClick={() => setIsLibraryExpanded(!isLibraryExpanded)}
                                className="hidden md:flex absolute -left-3 top-20 bg-white border border-slate-200 border-r-0 rounded-l-md p-1 shadow-sm text-slate-400 hover:text-emerald-600 transition z-50 items-center justify-center h-8 w-6"
                                title={isLibraryExpanded ? "Collapse Library" : "Expand Library"}
                            >
                                {isLibraryExpanded ? <ChevronRight className="w-4 h-4" /> : <ChevronLeft className="w-4 h-4" />}
                            </button>
                            <div className="p-4 border-b border-slate-100 flex flex-col gap-3">
                                <h3 className="font-bold text-slate-700">Drill Library</h3>
                                <div className="relative">
                                    <Search className="w-4 h-4 absolute left-3 top-3 text-slate-400" />
                                    <input 
                                        type="text" 
                                        placeholder="Search drills..." 
                                        className="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-md text-sm focus:outline-none focus:border-emerald-500" 
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                </div>
                                
                                {/* Category Filter */}
                                <div className={`flex gap-2 ${isLibraryExpanded ? 'flex-wrap' : 'overflow-x-auto pb-2 -mx-4 px-4 custom-scrollbar'}`}>
                                    {['All', 'Conditioning', 'Warmups', 'Fun Games', 'Ghosting', 'Drills - Racketwork', 'Feeding Drills', 'Condition Games', 'Fitness', 'Movement', 'Circuits (Score/Time)', 'Hand-Eye Coordination'].map(cat => (
                                        <button 
                                            key={cat}
                                            onClick={() => setSelectedCategory(cat)}
                                            className={`whitespace-nowrap px-3 py-1 rounded-full text-xs font-bold border transition ${selectedCategory === cat ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:border-emerald-300'}`}
                                        >
                                            {cat === 'Warmups' && <Flame className="w-3 h-3 inline mr-1" />}
                                            {cat === 'Fun Games' && <Trophy className="w-3 h-3 inline mr-1" />}
                                            {cat === 'Hand-Eye Coordination' && <Target className="w-3 h-3 inline mr-1" />}
                                            {cat === 'Ghosting' && <Footprints className="w-3 h-3 inline mr-1" />}
                                            {cat === 'Fitness' && <Dumbbell className="w-3 h-3 inline mr-1" />}
                                            {cat}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className={`flex-1 overflow-y-auto p-2 ${isLibraryExpanded ? 'grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 content-start' : 'space-y-2'}`}>
                                {availableDrills.filter(d => {
                                    const matchCat = selectedCategory === 'All' || d.type === selectedCategory;
                                    const matchSearch = d.name.toLowerCase().includes(searchQuery.toLowerCase());
                                    return matchCat && matchSearch;
                                }).map(drill => (
                                    <div key={drill.id} className="group p-3 rounded-md border border-slate-100 hover:border-emerald-200 hover:bg-emerald-50 transition cursor-pointer bg-white shadow-sm relative" onClick={() => setExpandedDrillId(expandedDrillId === drill.id ? null : drill.id)}>
                                        <div className="flex justify-between items-start"><h4 className="font-medium text-sm text-slate-800">{drill.name}</h4>
                                        <div className="flex gap-1">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); setSelectedDrill(drill); }}
                                                className="p-1 text-slate-400 hover:text-blue-500 transition" 
                                                title="Full Details"
                                            >
                                                <Info className="w-3 h-3" />
                                            </button>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); addDrillToPlan(drill); setIsLibraryExpanded(false); }}
                                                className="md:opacity-0 md:group-hover:opacity-100 p-1 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition" 
                                                title={planningTab === 'all' ? "Add to ALL courts" : `Add to Court ${planningTab + 1}`}
                                            >
                                                <Plus className="w-3 h-3" />
                                            </button>
                                        </div>
                                        </div>
                                        <div className="flex items-center gap-2 mt-2">
                                            <span className="text-xs bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">{drill.type}</span>
                                            <span className="text-xs text-slate-400 flex items-center gap-1"><Clock className="w-3 h-3" /> {formatTime(drill.defaultDuration)}</span>
                                            {drill.created_by_id && <span className="text-[10px] bg-indigo-50 text-indigo-600 px-1 rounded flex items-center gap-1"><Users className="w-3 h-3" /> Custom</span>}
                                        </div>

                                        {/* Quick Preview Mode */}
                                        {expandedDrillId === drill.id && (
                                            <div className="mt-3 animate-in slide-in-from-top-2 duration-200">
                                                <div className="relative aspect-video bg-black rounded overflow-hidden">
                                                    {drill.video_url ? (
                                                        <iframe 
                                                            className="w-full h-full" 
                                                            src={`https://www.youtube.com/embed/${getYouTubeId(drill.video_url)}?origin=${encodeURIComponent(window.location.origin)}&rel=0&enablejsapi=1`} 
                                                            title={drill.name}
                                                            frameBorder="0" 
                                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                                            referrerPolicy="strict-origin-when-cross-origin"
                                                            allowFullScreen
                                                        ></iframe>
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center text-slate-500 text-xs">No Video Available</div>
                                                    )}
                                                </div>
                                                <p className="text-xs text-slate-600 mt-2 line-clamp-3">{drill.description || "No description provided."}</p>
                                            </div>
                                        )}
                                    </div>
                                ))}
                                <div className="p-4 border-t border-slate-100 mt-4"><button onClick={() => setShowCreateDrillModal(true)} className="w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 rounded-md text-sm hover:border-emerald-400 hover:text-emerald-600 transition flex items-center justify-center gap-2"><Plus className="w-4 h-4" /> Create Custom Drill</button></div>
                            </div>
                        </aside>

                        {/* MOBILE BOTTOM NAV */}
                        <div className="md:hidden bg-white border-t border-slate-200 flex justify-around p-2 pb-safe z-30">
                            <button onClick={() => setActiveMobileTab('players')} className={`flex flex-col items-center p-2 rounded-lg transition ${activeMobileTab === 'players' ? 'text-emerald-600 bg-emerald-50' : 'text-slate-400'}`}>
                                <Users className="w-6 h-6" />
                                <span className="text-[10px] font-bold mt-1">Players</span>
                            </button>
                            <button onClick={() => setActiveMobileTab('plan')} className={`flex flex-col items-center p-2 rounded-lg transition ${activeMobileTab === 'plan' ? 'text-emerald-600 bg-emerald-50' : 'text-slate-400'}`}>
                                <List className="w-6 h-6" />
                                <span className="text-[10px] font-bold mt-1">Plan</span>
                            </button>
                        </div>
                        
                        {/* Drill Details Modal */}
                        {selectedDrill && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200" onClick={() => setSelectedDrill(null)}>
                                <div 
                                    className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 animate-in zoom-in-95 duration-200" 
                                    onClick={e => e.stopPropagation()}
                                >
                                    <div className="relative aspect-video bg-slate-900">
                                        {selectedDrill.video_url ? (
                                            <iframe 
                                                className="w-full h-full" 
                                                src={`https://www.youtube.com/embed/${getYouTubeId(selectedDrill.video_url)}?origin=${encodeURIComponent(window.location.origin)}&rel=0&enablejsapi=1`} 
                                                title={selectedDrill.name}
                                                frameBorder="0" 
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                                referrerPolicy="strict-origin-when-cross-origin"
                                                allowFullScreen
                                            ></iframe>
                                        ) : (
                                            <div className="w-full h-full flex flex-col items-center justify-center text-slate-500">
                                                <Play className="w-12 h-12 opacity-20 mb-2" />
                                                <span className="text-xs font-medium uppercase tracking-wider opacity-60">No Video Preview</span>
                                            </div>
                                        )}
                                        <button 
                                            onClick={() => setSelectedDrill(null)}
                                            className="absolute top-3 right-3 p-2 bg-black/20 hover:bg-black/40 text-white rounded-full backdrop-blur-md transition"
                                        >
                                            <X className="w-4 h-4" />
                                        </button>
                                    </div>
                                    
                                    <div className="p-6">
                                        <div className="flex items-start justify-between gap-4 mb-4">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${
                                                        selectedDrill.difficulty === 'Advanced' ? 'bg-red-100 text-red-700' :
                                                        selectedDrill.difficulty === 'Intermediate' ? 'bg-amber-100 text-amber-700' :
                                                        'bg-emerald-100 text-emerald-700'
                                                    }`}>
                                                        {selectedDrill.difficulty || 'All Levels'}
                                                    </span>
                                                    <span className="text-xs text-slate-400 font-medium flex items-center gap-1">
                                                        <Clock className="w-3 h-3" /> {formatTime(selectedDrill.defaultDuration || selectedDrill.duration || 600)}
                                                    </span>
                                                </div>
                                                <h2 className="text-2xl font-bold text-slate-800 leading-tight">{selectedDrill.name || selectedDrill.customName}</h2>
                                            </div>
                                        </div>
                                        
                                        <div className="prose prose-sm prose-slate mb-6 max-h-40 overflow-y-auto custom-scrollbar">
                                            <p className="text-slate-600 leading-relaxed">
                                                {selectedDrill.description || "No description provided for this drill."}
                                            </p>
                                        </div>
                                        
                                        {!selectedDrill.uid && (
                                            <button 
                                                onClick={() => { addDrillToPlan(selectedDrill); setSelectedDrill(null); }}
                                                className="w-full py-3 bg-slate-900 hover:bg-emerald-600 text-white font-bold rounded-xl transition shadow-lg flex items-center justify-center gap-2 group"
                                            >
                                                <Plus className="w-5 h-5 group-hover:scale-110 transition-transform" /> 
                                                Add to Session Plan
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Create Drill Modal */}
                        {showCreateDrillModal && (
                            <CreateDrillModal 
                                onClose={() => setShowCreateDrillModal(false)}
                                onCreated={(newDrill) => setAvailableDrills([...availableDrills, newDrill])}
                            />
                        )}

                        {/* Notes Modal */}
                        {showNotesModal && (
                            <NotesModal 
                                onClose={() => setShowNotesModal(false)} 
                                notes={notes}
                                onAddNote={(newNote) => setNotes([newNote, ...notes])}
                            />
                        )}

                        {/* Mobile Drill Picker Modal */}
                        {showMobileDrillPicker && (
                            <MobileDrillPicker 
                                onClose={() => setShowMobileDrillPicker(false)}
                                availableDrills={availableDrills}
                                formatTime={formatTime}
                                onAdd={(drill) => {
                                    addDrillToPlan(drill);
                                    setShowMobileDrillPicker(false);
                                }}
                                onCreate={() => {
                                    setShowMobileDrillPicker(false);
                                    setShowCreateDrillModal(true);
                                }}
                            />
                        )}
                        {/* Save/Load Template Modals */}
                        {showLoadTemplateModal && (
                            <LoadTemplateModal 
                                onClose={() => setShowLoadTemplateModal(false)}
                                onLoad={handleTemplateLoaded}
                            />
                        )}

                        {showSaveTemplateModal && (
                            <SaveTemplateModal 
                                onClose={() => setShowSaveTemplateModal(false)}
                                onSave={() => console.log("Template Saved")}
                                planData={courtPlans}
                                courtCount={numCourts}
                            />
                        )}
                    </main>
                </div>
            );
        }

        // 5. Mount the application
        const root = createRoot(document.getElementById('root'));
        root.render(<SquashSyncPlanner />);
    </script>
</body>
</html>
