{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Set My Bulk Availability" }}{% endblock %}

{% block extra_head %}
    {% endblock %}

{% block content %}
<div class="content-wrapper">
    <h1><i class="bi bi-calendar2-week"></i> {{ page_title }}</h1>

    <div class="color-key">
        <strong>Key:</strong>
        <span class="color-key-item"><div class="color-key-swatch" style="background-color: #198754;"></div> Available</span>
        <span class="color-key-item"><div class="color-key-swatch" style="background-color: #dc3545;"></div> Unavailable</span>
        <span class="color-key-item"><div class="color-key-swatch" style="background-color: #0d6efd;"></div> Emergency Only</span>
        <span class="color-key-item"><div class="color-key-swatch" style="background-color: #6c757d;"></div> No Preference</span>
    </div>

    <p class="helptext">
        <small>Tap a block to cycle its status. Your preference will be applied to all sessions generated from that rule for the selected month.</small>
    </p>

    <form method="GET" action="{% url 'scheduling:set_bulk_availability' %}" class="month-year-selector-form">
        <div class="form-group">
            <label for="{{ month_year_form.month.id_for_label }}">{{ month_year_form.month.label }}:</label>
            {{ month_year_form.month }}
        </div>
        <div class="form-group">
            <label for="{{ month_year_form.year.id_for_label }}">{{ month_year_form.year.label }}:</label>
            {{ month_year_form.year }}
        </div>
        <button type="submit" class="btn btn-sm btn-secondary">View Schedules</button>
    </form>
    <hr>

    <form method="POST" action="{% url 'scheduling:set_bulk_availability' %}">
        {% csrf_token %}
        <input type="hidden" name="month" value="{{ selected_month }}">
        <input type="hidden" name="year" value="{{ selected_year }}">

        <h2>Availability for Recurring Schedules in: {{ selected_month_display }} {{ selected_year }}</h2>

        {% for day_name, classes in grouped_classes.items %}
            {% if classes %}
                <details class="day-accordion-item" open>
                    <summary>
                        <span>{{ day_name }}</span>
                        <span class="arrow"></span>
                    </summary>
                    <div class="sessions-grid">
                        {% for rule in classes %}
                            <div class="availability-item status-no-change" 
                                 data-rule-id="{{ rule.id }}" 
                                 data-status="NO_CHANGE"
                                 data-group-description="{{ rule.school_group.description|escapejs }}"
                                 data-group-name="{{ rule.school_group.name }}"
                                 role="button">
                                
                                <i class="bi bi-info-circle-fill description-trigger" title="View group description"></i>
                                <strong>{{ rule.start_time|time:"H:i" }}</strong>
                                <span>{{ rule.school_group.name }}</span>
                                </div>
                            <input type="hidden" name="availability_rule_{{ rule.id }}" id="input_rule_{{ rule.id }}" value="NO_CHANGE">
                        {% endfor %}
                    </div>
                </details>
            {% endif %}
        {% endfor %}
        
        <div class="main-submit-button-container">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-check2-square"></i> Apply My Availability for {{ selected_month_display }}
            </button>
        </div>
    </form>
</div>

<div id="descriptionModal" class="custom-modal-overlay">
    <div class="custom-modal-content">
        <button id="descriptionModalClose" class="custom-modal-close" aria-label="Close">&times;</button>
        <h4 id="modalGroupName">Group Description</h4>
        <p id="modalGroupDescription"></p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const availabilityItems = document.querySelectorAll('.availability-item');
    const descriptionModal = document.getElementById('descriptionModal');
    const descriptionModalClose = document.getElementById('descriptionModalClose');
    const modalGroupName = document.getElementById('modalGroupName');
    const modalGroupDescription = document.getElementById('modalGroupDescription');

    const states = [
        { value: 'AVAILABLE',   cssClass: 'status-available' },
        { value: 'UNAVAILABLE', cssClass: 'status-unavailable' },
        { value: 'EMERGENCY',   cssClass: 'status-emergency' },
        { value: 'NO_CHANGE',   cssClass: 'status-no-change' }
    ];

    function cycleStatus(item) {
        const currentStatus = item.dataset.status;
        const currentIndex = states.findIndex(s => s.value === currentStatus);
        const nextIndex = (currentIndex + 1) % states.length;
        const nextState = states[nextIndex];

        item.dataset.status = nextState.value;
        item.className = `availability-item ${nextState.cssClass}`;

        const hiddenInput = document.getElementById(`input_rule_${item.dataset.ruleId}`);
        if (hiddenInput) {
            hiddenInput.value = nextState.value;
        }
    }
    
    // THIS IS THE FIX: Added the logic to show the description modal
    function showDescription(item) {
        const description = item.dataset.groupDescription;
        const groupName = item.dataset.groupName;
        modalGroupName.textContent = `Description for: ${groupName}`;
        modalGroupDescription.textContent = description || "No description provided.";
        if(descriptionModal) descriptionModal.style.display = 'flex';
    }

    availabilityItems.forEach(item => {
        item.addEventListener('click', function(event) {
            // Check if the icon was clicked
            if (event.target.classList.contains('description-trigger')) {
                event.stopPropagation();
                showDescription(this);
            } else {
                cycleStatus(this);
            }
        });
    });

    function closeModal(modal) {
        if (modal) modal.style.display = 'none';
    }

    if (descriptionModalClose) {
        descriptionModalClose.addEventListener('click', () => closeModal(descriptionModal));
    }
});
</script>
{% endblock %}