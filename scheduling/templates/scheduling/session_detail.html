{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<style>
    /* Base Planner Styles */
    .planner-section { border: 1px solid var(--bs-border-color); border-radius: 0.5rem; margin-bottom: 1.5rem; }
    .planner-header { background-color: var(--bs-secondary-bg); padding: 0.75rem 1.25rem; border-bottom: 1px solid var(--bs-border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .planner-header h4 { margin: 0; }
    .planner-header .arrow { transition: transform 0.3s ease; }
    .planner-content { padding: 1.25rem; display: none; }
    .planner-section.is-open .planner-content { display: block; }
    .planner-section.is-open .arrow { transform: rotate(180deg); }
</style>
{% endblock %}


{% block content %}
<div id="session-planner-app" 
     class="container-fluid" 
     data-session-id="{{ session.id }}" 
     data-save-url=""
     data-update-attendance-url="{% url 'scheduling:update_attendance_status' 0 %}"
     data-session-start-time="{{ session.session_start_time|time:'H:i' }}">
    
    <div class="row align-items-md-center mb-4">
        <div class="col-12 col-md-7">
            <h1 class="mb-0">{{ page_title }}</h1>
            <p class="text-muted">{{ session.session_date|date:"l, F j, Y" }} at {{ session.session_start_time|time:"H:i" }} &bull; <i class="bi bi-clock"></i> {{ session.planned_duration_minutes }} min total</p>
                {% if coaches %}
                    <p class="text-muted mb-0">
                        <i class="bi bi-person-check-fill"></i>
                        <strong>Coaches:</strong>
                        {% for coach in coaches %}
                            {{ coach.user.get_full_name|default:coach.name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </p>
                {% endif %}
        </div>
        <div class="col-12 col-md-5 mt-3 mt-md-0">
            <div class="d-grid gap-2 d-md-block">
                <a href="{% url 'scheduling:visual_attendance' session.id %}" class="btn btn-info"><i class="bi bi-person-check"></i> Take Attendance</a>
                <a href="{% url 'live_session:planner_v2' session.id %}" class="btn btn-primary" target="_blank"><i class="bi bi-calendar-week"></i> Open Planner</a>
            </div>
        </div>
    </div>

    <div id="setup-section" class="planner-section is-open">
        <div class="planner-header">
            <div class="d-flex align-items-center gap-3">
                <h4><i class="bi bi-check2-circle"></i> 1. Expected Players</h4>
                <div class="input-group input-group-sm" style="max-width: 300px;">
                    <span class="input-group-text">Registration Link</span>
                    <input type="text" class="form-control" value="{{ request.scheme }}://{{ request.get_host }}/players/notifications/register/" readonly onclick="this.select()">
                </div>
            </div>
            <i class="bi bi-chevron-down arrow"></i>
        </div>
        <div class="planner-content">
            <div id="attendance-list" class="mb-2"></div>
        </div>
    </div>
</div>

    <!-- Session History Section -->
    <div class="mt-5 pt-4 border-top">
        <h4 class="mb-3">Session History (This Year)</h4>
        {% if past_sessions %}
            <div class="row">
                {% for session in past_sessions %}
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title mb-0">{{ session.date|date:"d M Y" }}</h5>
                                    <a href="{% url 'scheduling:session_detail' session.id %}" class="btn btn-sm btn-outline-primary">View</a>
                                </div>
                                    {{ session.drill_summary|default:"No drills recorded" }}
                                </p>
                                
                                {% if session.groupings %}
                                    <div class="mt-3">
                                        <h6 class="text-uppercase text-secondary small fw-bold mb-2">Groupings</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            {% for group in session.groupings %}
                                                <div class="p-2 bg-body-tertiary rounded border">
                                                    <div class="small fw-bold mb-1">{{ group.court_name }}</div>
                                                    <div class="d-flex flex-wrap gap-1">
                                                        {% for player_name in group.players %}
                                                            <span class="badge bg-secondary text-white fw-normal" style="font-size: 0.7rem;">{{ player_name }}</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">No past finished sessions found for this group in the current year.</p>
        {% endif %}
    </div>

    <!-- Email Update Modal -->
    <div class="modal fade" id="emailUpdateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Notification Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="emailUpdateForm">
                        <div class="mb-3">
                            <label for="playerEmailInput" class="form-label">Notification Email</label>
                            <input type="email" class="form-control" id="playerEmailInput" placeholder="name@example.com" required>
                            <div class="form-text">This will verify this email for session reminders for this player.</div>
                        </div>
                        <input type="hidden" id="emailUpdatePlayerId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEmailBtn">Save Email</button>
                </div>
            </div>
        </div>
    </div>

{{ all_players_for_display|json_script:"all-players-data" }}

{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/session_planner.js' %}?v=1.3"></script>
    <script>
        function copyRegistrationLink() {
            const url = window.location.origin + "/players/notifications/register/";
            navigator.clipboard.writeText(url).then(() => {
                // Show a simple toast or alert
                // Assuming Bootstrap Tooltip usage, but for now simple alert or button text change
                const btn = document.querySelector('button[onclick="copyRegistrationLink()"]');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
                btn.classList.replace('btn-outline-secondary', 'btn-success');
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.replace('btn-success', 'btn-outline-secondary');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                prompt("Copy link:", url);
            });
        }
    </script>
{% endblock %}