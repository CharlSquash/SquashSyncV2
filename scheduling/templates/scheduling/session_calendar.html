{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ page_title }} - SquashSync{% endblock %}

{% block extra_head %}
<style>
    /* Responsive styling for the calendar */
    @media (max-width: 767px) {
        .calendar-container {
            padding: 0 .5rem; /* Reduce side padding on mobile */
        }
        /* Clean up toolbar on mobile */
        .fc .fc-toolbar-title {
            font-size: 1.25em; /* Make title smaller */
        }
        .fc .fc-toolbar.fc-header-toolbar {
            /* Allow button groups to wrap onto a new line if needed */
            flex-wrap: wrap;
            margin-bottom: 1em;
        }
    }

    /* --- NEW: Visual indicator for completed attendance --- */
    .fc-event-attendance-taken {
        border-left: 5px solid #198754 !important; /* Thick green left border */
    }
    .fc-direction-ltr .fc-daygrid-event.fc-event-attendance-taken .fc-event-main {
        /* Add a little padding so the text doesn't touch the border */
        padding-left: 4px;
    }
    .fc-direction-rtl .fc-daygrid-event.fc-event-attendance-taken .fc-event-main {
        padding-right: 4px;
    }

    /* Management Mode: Read Only State */
    .calendar-read-only .fc-daygrid-day-frame, 
    .calendar-read-only .fc-timegrid-slot {
        pointer-events: none; /* Disable clicking empty slots */
    }
    .calendar-read-only .fc-event {
        pointer-events: auto; /* Allow clicking events (for details) */
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h1>{{ page_title|default:"Session Calendar" }}</h1>

        {# --- NEW TOGGLE BUTTONS --- #}
        {% if can_view_all and not user.is_superuser %}
            <div class="btn-group" role="group">
                <a href="{% url 'scheduling:session_calendar' %}" class="btn {% if not is_all_view %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    My Sessions
                </a>
                <a href="{% url 'scheduling:session_calendar' %}?view=all" class="btn {% if is_all_view %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    All Sessions
                </a>
            </div>
        {% endif %}
        {# --- END OF NEW TOGGLE --- #}

        {# --- END OF NEW TOGGLE --- #}

        {# --- ACTION BUTTONS (WEEKLY & SYNC) --- #}
        <div class="d-flex flex-wrap gap-2 ms-2">
            {% if user.is_staff %}
                <button id="openWeeklyOverviewBtn" type="button" class="btn btn-info flex-grow-1"><i class="bi bi-table"></i> Weekly Schedule</button>
            {% endif %}

            {% if calendar_sync_url %}
                <button type="button" class="btn btn-outline-info flex-grow-1" data-bs-toggle="modal" data-bs-target="#calendarSyncModal">
                    <i class="bi bi-arrow-repeat"></i> Sync Calendar
                </button>
            {% endif %}
        </div>
    </div>
    <div class="d-flex align-items-center mb-3 flex-wrap">
        <span class="me-3 fw-bold">Layers:</span>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="" id="toggleSessions" checked>
            <label class="form-check-label" for="toggleSessions">
                Sessions
            </label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="" id="toggleTasks" checked>
            <label class="form-check-label" for="toggleTasks">
                Tasks
            </label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="" id="toggleEvents">
            <label class="form-check-label" for="toggleEvents">
                Events
            </label>
        </div>
        
        {% if user.is_superuser %}
        <div class="ms-4 ps-4 border-start">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="toggleManagementMode">
                <label class="form-check-label fw-bold text-danger" for="toggleManagementMode">Enable Management Mode</label>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="row">
        <div class="col-12">
            <div class="calendar-container">
                <div id="sessionCalendar"></div>
            </div>
        </div>
    </div>
</div>

<div id="sessionDetailModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="modal-header">
            <h2 id="modalTitle"></h2>
        </div>
        <div class="modal-body">
            <p><strong>Date:</strong> <span id="modalDate"></span></p>
            <p><strong>Time:</strong> <span id="modalTime"></span></p>
            <p><strong>Venue:</strong> <span id="modalVenue"></span></p>
            <p><strong>Coaches:</strong> <span id="modalCoaches"></span></p>
            <p><strong>Session Status:</strong> <span id="modalStatus"></span></p>
        </div>
        <div class="modal-actions">
            <a id="sessionPlanLink" href="#" class="btn btn-sm btn-primary">Go to Session Plan</a>
            {% if request.user.is_superuser %}
                <a id="adminLink" href="#" class="btn btn-sm btn-secondary" target="_blank">Edit (Admin)</a>
            {% endif %}
        </div>
    </div>
</div>
<div id="eventDetailModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="modal-header">
            <h2 id="eventModalTitle"></h2>
        </div>
        <div class="modal-body">
            <p><strong>Date:</strong> <span id="eventModalDate"></span></p>
            <p><strong>Type:</strong> <span id="eventModalType"></span></p>
            <p><strong>Description:</strong> <span id="eventModalDescription"></span></p>
        </div>
        <div class="modal-actions">
            {% if request.user.is_superuser %}
                <button id="deleteEventBtn" class="btn btn-sm btn-danger">Delete Event</button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Management Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="managementOffcanvas" aria-labelledby="managementOffcanvasLabel">
  <div class="offcanvas-header bg-light">
    <h5 class="offcanvas-title" id="managementOffcanvasLabel">Manage Session</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form id="managementForm">
        <input type="hidden" id="mgmtSessionId">
        <div class="mb-3">
            <label for="mgmtGroup" class="form-label">School Group</label>
            <select class="form-select" id="mgmtGroup">
                <option value="">-- General / No Group --</option>
                {% for group in all_school_groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="mgmtVenue" class="form-label">Venue</label>
            <select class="form-select" id="mgmtVenue">
                <option value="">-- Select Venue --</option>
                {% for venue in all_venues %}
                    <option value="{{ venue.id }}">{{ venue.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="row mb-3">
            <div class="col">
                <label for="mgmtDate" class="form-label">Date</label>
                <input type="date" class="form-control" id="mgmtDate" required>
            </div>
            <div class="col">
                <label for="mgmtTime" class="form-label">Time</label>
                <input type="time" class="form-control" id="mgmtTime" required>
            </div>
        </div>
        <div class="mb-3">
            <label for="mgmtDuration" class="form-label">Duration (min)</label>
            <input type="number" class="form-control" id="mgmtDuration" value="60" min="15">
        </div>
        <div class="mb-3">
             <label for="mgmtNotes" class="form-label">Notes</label>
             <textarea class="form-control" id="mgmtNotes" rows="2"></textarea>
        </div>

        <div id="recurringWarning" class="alert alert-warning d-none">
            <small><i class="fas fa-exclamation-triangle"></i> This session was generated from a recurring rule. Changes here will only affect this specific date.</small>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary" id="mgmtSaveBtn">Create Session</button>
            <button type="button" class="btn btn-danger d-none" id="mgmtDeleteBtn">Delete Session</button>
        </div>
    </form>
  </div>
</div>



<!-- Calendar Sync Modal -->
<div class="modal fade" id="calendarSyncModal" tabindex="-1" aria-labelledby="calendarSyncModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarSyncModalLabel">Sync to Your Calendar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Click the link below to select it, then copy it manually (Ctrl+C) and add it to your calendar app as a 'Subscription' or 'URL' calendar.</p>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" value="{{ calendar_sync_url }}" id="calendarSyncLink" readonly onclick="this.select()">
                </div>
                <small class="text-muted">This feed includes your sessions for the future and the past 3 months.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Weekly Overview Modal -->
<div class="modal fade" id="weeklyOverviewModal" tabindex="-1" aria-labelledby="weeklyOverviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="weeklyOverviewModalLabel">Weekly Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="weeklyOverviewContent">
                <!-- Content injected via AJAX -->
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>




{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/fullcalendar/index.global.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('sessionCalendar');
    
    // --- Parse Data Sources ---
    let sessionsEvents = [];
    let tasksEvents = [];
    
    try {
        sessionsEvents = JSON.parse('{{ events_json|escapejs }}');
    } catch (e) { console.error("Error parsing events_json:", e); }

    try {
        tasksEvents = JSON.parse('{{ tasks_json|escapejs }}');
    } catch (e) { console.error("Error parsing tasks_json:", e); }

    let specialEvents = [];
    try {
        specialEvents = JSON.parse('{{ special_events_json|escapejs }}');
    } catch (e) { console.error("Error parsing special_events_json:", e); }

    const isMobile = window.innerWidth < 768;

    // --- Define Event Sources ---
    const sessionsSource = {
        id: 'sessions',
        events: sessionsEvents,
        // You can add default color/className for this source here if you want
    };

    const tasksSource = {
        id: 'tasks',
        events: tasksEvents,
        color: '#ffc107', // Fallback color if not set in event
        textColor: '#000' // Ensure text is readable on yellow
    };

    const specialEventsSource = {
        id: 'specialEvents',
        events: specialEvents,
        color: '#17a2b8', // Info Teal
        textColor: '#fff'
    };
    
    // --- Management Mode Logic ---
    let isManagementMode = false;
    const managementOffcanvasEl = document.getElementById('managementOffcanvas');
    let managementOffcanvas = null;
    if (managementOffcanvasEl) {
        managementOffcanvas = new bootstrap.Offcanvas(managementOffcanvasEl);
    }
    const toggleManagementControl = document.getElementById('toggleManagementMode');

    // --- Initialize Calendar ---
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: isMobile ? 'listWeek' : 'dayGridMonth',
        
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },

        height: 'auto',

        // Sort events by custom sortIndex (calculated in backend for venue grouping)
        eventOrder: function(a, b) {
            return (a.extendedProps.sortIndex || 0) - (b.extendedProps.sortIndex || 0);
        },

        eventDisplay: 'block', // Force all events to render as blocks (not dots) in Month view

        eventDidMount: function(info) {
             // Handle List View Coloring
            if (info.view.type === 'listWeek' || info.view.type === 'listDay' || info.view.type === 'listMonth') {
                const titleEl = info.el.querySelector('.fc-list-event-title');
                if (titleEl) {
                    // Use the contrast color sent from backend, fallback to textColor, then dark grey
                    const color = info.event.extendedProps.contrastColor || info.event.textColor || '#333333';
                    titleEl.style.color = color;
                    titleEl.style.fontWeight = 'bold'; 
                }
            } else {
                // Ensure colors are applied in Block views (Month/TimeGrid)
                if (info.event.backgroundColor) {
                     info.el.style.backgroundColor = info.event.backgroundColor;
                }
                if (info.event.borderColor) {
                     info.el.style.borderColor = info.event.borderColor; 
                }
                if (info.event.textColor) {
                     info.el.style.color = info.event.textColor;
                }
            }
        },

        // Start with ONLY sessions by default (as per requirement)
        eventSources: [ sessionsSource, tasksSource ],

        selectable: true, // Always true to allow 'select' callback to handle management checks
        editable: false,   // DISABLE GLOBAL EDITING (Drag & Drop)
        eventStartEditable: false,
        eventDurationEditable: false,

        eventClick: function(info) {
            info.jsEvent.preventDefault();
            const event = info.event;
            const props = event.extendedProps;

            // Handle Task Clicks (Redirect)
            if (props.type === 'task') {
                window.location.href = event.url;
                return;
            }

            // Handle Special Event Clicks (Modal)
            if (props.type === 'event') {
                document.getElementById('eventModalTitle').textContent = event.title;
                document.getElementById('eventModalDate').textContent = new Date(event.startStr).toLocaleDateString();
                document.getElementById('eventModalType').textContent = props.event_type;
                document.getElementById('eventModalDescription').textContent = props.description || 'No description';
                
                const deleteBtn = document.getElementById('deleteEventBtn');
                if (deleteBtn) {
                    deleteBtn.setAttribute('data-event-id', event.id);
                }
                
                document.getElementById('eventDetailModal').style.display = 'block';
                return;
            }

            // MANAGEMENT MODE CLICK: EDIT SESSION
            if (isManagementMode && !props.type) { // !props.type ensures it's a session (tasks/events have 'type')
                 openManagementOffcanvas('edit', event);
                 return;
            }

            // Handle Session Clicks (Read-Only Modal)
            document.getElementById('modalTitle').textContent = `${props.school_group_name} Session`;
            document.getElementById('modalDate').textContent = new Date(event.startStr).toLocaleDateString();
            document.getElementById('modalTime').textContent = props.session_time_str;
            document.getElementById('modalVenue').textContent = props.venue_name;
            document.getElementById('modalCoaches').textContent = props.coaches_attending.join(', ');
            document.getElementById('modalStatus').textContent = props.status_display;

            document.getElementById('sessionPlanLink').href = event.url;
            
            const adminLink = document.getElementById('adminLink');
            if (adminLink) {
                adminLink.href = props.admin_url;
            }

            document.getElementById('sessionDetailModal').style.display = 'block';
        },

        eventDrop: function(info) {
            const props = info.event.extendedProps;
            
            // Handle Session Updates in Management Mode
            // Handle Session Updates in Management Mode - REMOVED DRAG DROP
            if (!props.type) { 
                 info.revert();
                 return;
            }

            // Handle Special Event Drag & Drop
            if (props.type === 'event') {
                if (!confirm(`Are you sure you want to move "${info.event.title}" to ${info.event.start.toLocaleDateString()}?`)) {
                    info.revert();
                    return;
                }

                fetch("{% url 'scheduling:update_event_date' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        event_id: info.event.id, // Note: Ensure your Event objects have IDs in the JSON
                        start: info.event.startStr
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Optional: Show a toast or notification
                        console.log('Event moved successfully');
                    } else {
                        alert('Failed to move event: ' + data.message);
                        info.revert();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while moving the event.');
                    info.revert();
                });
            }
        },
        
        select: function(info) {
            if (isManagementMode) {
                openManagementOffcanvas('create', null, info);
            } else {
                calendar.unselect();
            }
        }
    });

    calendar.render();

    // --- Layer Toggling Logic ---
    const toggleSessions = document.getElementById('toggleSessions');
    const toggleTasks = document.getElementById('toggleTasks');

    if (toggleSessions) {
        toggleSessions.addEventListener('change', function() {
            if (this.checked) {
                calendar.addEventSource(sessionsSource);
            } else {
                const source = calendar.getEventSourceById('sessions');
                if (source) source.remove();
            }
        });
    }

    if (toggleTasks) {
        toggleTasks.addEventListener('change', function() {
            if (this.checked) {
                calendar.addEventSource(tasksSource);
            } else {
                const source = calendar.getEventSourceById('tasks');
                if (source) source.remove();
            }
        });
    }



    const toggleEvents = document.getElementById('toggleEvents');
    if (toggleEvents) {
        toggleEvents.addEventListener('change', function() {
            if (this.checked) {
                calendar.addEventSource(specialEventsSource);
            } else {
                const source = calendar.getEventSourceById('specialEvents');
                if (source) source.remove();
            }
        });
    }
    
    // --- Management Mode Toggle ---
    if (toggleManagementControl) {
        toggleManagementControl.addEventListener('change', function() {
            isManagementMode = this.checked;
            // selectable is permanent now, logic handled in validRange or select callback
            if (isManagementMode) {
                document.body.classList.add('management-mode-active');
                document.querySelector('.calendar-container').classList.remove('calendar-read-only');
            } else {
                document.body.classList.remove('management-mode-active');
                document.querySelector('.calendar-container').classList.add('calendar-read-only');
            }
        });
        
        // Initialize state
        document.querySelector('.calendar-container').classList.add('calendar-read-only');
    }
    
    // --- Management Helper Functions ---
    function openManagementOffcanvas(mode, event=null, selectInfo=null) {
        if (!managementOffcanvas) return;
        
        const form = document.getElementById('managementForm');
        form.reset();
        document.getElementById('mgmtSessionId').value = '';
        document.getElementById('recurringWarning').classList.add('d-none');
        document.getElementById('mgmtDeleteBtn').classList.add('d-none');
        
        if (mode === 'create') {
            document.getElementById('managementOffcanvasLabel').textContent = "Create New Session";
            document.getElementById('mgmtSaveBtn').textContent = "Create Session";
            
            // Pre-fill from selection
            if (selectInfo) {
                document.getElementById('mgmtDate').value = selectInfo.startStr.split('T')[0];
                if (selectInfo.startStr.includes('T')) {
                     const timePart = selectInfo.startStr.split('T')[1].substring(0, 5);
                     document.getElementById('mgmtTime').value = timePart;
                } else {
                    document.getElementById('mgmtTime').value = "09:00"; // Default
                }
            }
        } else if (mode === 'edit' && event) {
            document.getElementById('managementOffcanvasLabel').textContent = "Edit Session";
            document.getElementById('mgmtSaveBtn').textContent = "Update Session";
            document.getElementById('mgmtDeleteBtn').classList.remove('d-none');
            
            const props = event.extendedProps;
            document.getElementById('mgmtSessionId').value = event.id;
            
            // Pre-fill using new ExtendedProps
            if(props.venue_id) document.getElementById('mgmtVenue').value = props.venue_id;
            if(props.school_group_id) document.getElementById('mgmtGroup').value = props.school_group_id;
            if(props.duration) document.getElementById('mgmtDuration').value = props.duration;
            if(props.notes) document.getElementById('mgmtNotes').value = props.notes;
            
            document.getElementById('mgmtDate').value = event.start.toISOString().split('T')[0];
            document.getElementById('mgmtTime').value = event.start.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'});
            
            if (props.is_recurring) {
                document.getElementById('recurringWarning').classList.remove('d-none');
            }
        }
        
        managementOffcanvas.show();
    }
    
    // Management Save Handler
    document.getElementById('managementForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const sessionId = document.getElementById('mgmtSessionId').value;
        const url = sessionId ? "{% url 'scheduling:update_session_ajax' %}" : "{% url 'scheduling:create_session_ajax' %}";
        
        const payload = {
            session_id: sessionId,
            school_group_id: document.getElementById('mgmtGroup').value,
            venue_id: document.getElementById('mgmtVenue').value,
            session_date: document.getElementById('mgmtDate').value,
            start_time: document.getElementById('mgmtTime').value,
            // For create, we use 'date'/'time', for update 'session_date'/'start_time' matching views.
            // To simplify, we'll send a superset or normalize.
            // Create view expects: date, time
            // Update view expects: session_date, start_time
            // Let's explicitly satisfy both or handle separation:
            date: document.getElementById('mgmtDate').value,
            time: document.getElementById('mgmtTime').value,
            
            duration: document.getElementById('mgmtDuration').value,
            notes: document.getElementById('mgmtNotes').value
        };
        
        fetch(url, {
            method: 'POST',
            body: JSON.stringify(payload),
             headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(r => r.json()).then(data => {
            if (data.status === 'success') {
                if (data.warning) {
                    alert("Session saved with warning:\n" + data.warning);
                }
                location.reload(); // Simple reload to reflect changes
            } else {
                alert("Error: " + data.message);
            }
        });
    });
    
    // Management Delete Handler
    document.getElementById('mgmtDeleteBtn').addEventListener('click', function() {
        if(!confirm("Are you sure you want to delete this session?")) return;
        const sessionId = document.getElementById('mgmtSessionId').value;
        fetch("{% url 'scheduling:delete_session_ajax' %}", {
            method: 'POST',
            body: JSON.stringify({session_id: sessionId}),
             headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(r => r.json()).then(data => {
             if (data.status === 'success') {
                location.reload();
            } else {
                alert("Error: " + data.message);
            }
        });
    });

    // Modal closing logic
    const modal = document.getElementById('sessionDetailModal');
    modal.querySelector('.close-button').onclick = () => modal.style.display = "none";
    
    const eventModal = document.getElementById('eventDetailModal');
    eventModal.querySelector('.close-button').onclick = () => eventModal.style.display = "none";

    window.onclick = (event) => {
        if (event.target == modal) {
            modal.style.display = "none";
        }
        if (event.target == eventModal) {
            eventModal.style.display = "none";
        }
    };
    
    // Delete Event Logics (Existing)
    const deleteBtn = document.getElementById('deleteEventBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            // ... (existing code)
            const eventId = this.getAttribute('data-event-id');
            if (!eventId) return;
            
            if (!confirm("Are you sure you want to delete this event? This cannot be undone.")) {
                return;
            }
            
            fetch("{% url 'scheduling:delete_event' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ event_id: eventId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const event = calendar.getEventById(eventId);
                    if (event) event.remove();
                    eventModal.style.display = "none";
                    // alert("Event deleted successfully.");
                } else {
                    alert("Failed to delete event: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the event.');
            });
        });
    }

    // --- Weekly Staffing Overview Logic ---
    // --- Weekly Staffing Overview Logic ---
    const openWeeklyOverviewBtn = document.getElementById('openWeeklyOverviewBtn');
    
    function loadWeeklyOverview(dateStr) {
        const modalBody = document.getElementById('weeklyOverviewContent');
        
        // Show loader (only if not already showing, or always? specific area?)
        // Ideally keep it smooth, but a loader is good for feedback.
        modalBody.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading schedule...</p>
            </div>
        `;
        
        // Fetch content
        fetch(`{% url 'scheduling:staffing_overview_modal' %}?date=${dateStr}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            })
            .then(html => {
                modalBody.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">Error loading data. Please try again.</div>`;
            });
    }

    if (openWeeklyOverviewBtn) {
        openWeeklyOverviewBtn.addEventListener('click', function() {
            // "But default back to current week when opened"
            // We use Today's date (or pass nothing, view defaults to today)
            const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD local
            
            const modalEl = document.getElementById('weeklyOverviewModal');
            const bsModal = new bootstrap.Modal(modalEl);
            
            // Show modal
            bsModal.show();
            
            // Load content for today
            loadWeeklyOverview(today);
        });
    }
    
    // Event Delegation for Navigation Buttons
    document.addEventListener('click', function(e) {
        if (e.target && e.target.closest('.weekly-overview-nav-btn')) {
            const btn = e.target.closest('.weekly-overview-nav-btn');
            const dateStr = btn.getAttribute('data-date');
            if (dateStr) {
                loadWeeklyOverview(dateStr);
            }
        }
    });


});
</script>
{% endblock %}


