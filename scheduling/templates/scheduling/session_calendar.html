{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ page_title }} - SquashSync{% endblock %}

{% block extra_head %}
<style>
    /* Responsive styling for the calendar */
    @media (max-width: 767px) {
        .calendar-container {
            padding: 0 .5rem; /* Reduce side padding on mobile */
        }
        /* Clean up toolbar on mobile */
        .fc .fc-toolbar-title {
            font-size: 1.25em; /* Make title smaller */
        }
        .fc .fc-toolbar.fc-header-toolbar {
            /* Allow button groups to wrap onto a new line if needed */
            flex-wrap: wrap;
            margin-bottom: 1em;
        }
    }

    /* --- NEW: Visual indicator for completed attendance --- */
    .fc-event-attendance-taken {
        border-left: 5px solid #198754 !important; /* Thick green left border */
    }
    .fc-direction-ltr .fc-daygrid-event.fc-event-attendance-taken .fc-event-main {
        /* Add a little padding so the text doesn't touch the border */
        padding-left: 4px;
    }
    .fc-direction-rtl .fc-daygrid-event.fc-event-attendance-taken .fc-event-main {
        padding-right: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="page-header d-flex justify-content-between align-items-center">
        <h1>{{ page_title|default:"Session Calendar" }}</h1>

        {# --- NEW TOGGLE BUTTONS --- #}
        {% if can_view_all and not user.is_superuser %}
            <div class="btn-group" role="group">
                <a href="{% url 'scheduling:session_calendar' %}" class="btn {% if not is_all_view %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    My Sessions
                </a>
                <a href="{% url 'scheduling:session_calendar' %}?view=all" class="btn {% if is_all_view %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    All Sessions
                </a>
            </div>
        {% endif %}
        {# --- END OF NEW TOGGLE --- #}

    </div>
    <div class="row">
        <div class="col-lg-2 mb-3">
            <div class="card">
                <div class="card-header">
                    Calendar Layers
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="toggleSessions" checked>
                        <label class="form-check-label" for="toggleSessions">
                            Squash Sessions
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="toggleTasks">
                        <label class="form-check-label" for="toggleTasks">
                            My Tasks
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-10">
            <div class="calendar-container">
                <div id="sessionCalendar"></div>
            </div>
        </div>
    </div>
</div>

<div id="sessionDetailModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="modal-header">
            <h2 id="modalTitle"></h2>
        </div>
        <div class="modal-body">
            <p><strong>Date:</strong> <span id="modalDate"></span></p>
            <p><strong>Time:</strong> <span id="modalTime"></span></p>
            <p><strong>Venue:</strong> <span id="modalVenue"></span></p>
            <p><strong>Coaches:</strong> <span id="modalCoaches"></span></p>
            <p><strong>Session Status:</strong> <span id="modalStatus"></span></p>
        </div>
        <div class="modal-actions">
            <a id="sessionPlanLink" href="#" class="btn btn-sm btn-primary">Go to Session Plan</a>
            {% if request.user.is_superuser %}
                <a id="adminLink" href="#" class="btn btn-sm btn-secondary" target="_blank">Edit (Admin)</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/fullcalendar/index.global.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('sessionCalendar');
    
    // --- Parse Data Sources ---
    let sessionsEvents = [];
    let tasksEvents = [];
    
    try {
        sessionsEvents = JSON.parse('{{ events_json|escapejs }}');
    } catch (e) { console.error("Error parsing events_json:", e); }

    try {
        tasksEvents = JSON.parse('{{ tasks_json|escapejs }}');
    } catch (e) { console.error("Error parsing tasks_json:", e); }

    const isMobile = window.innerWidth < 768;

    // --- Define Event Sources ---
    const sessionsSource = {
        id: 'sessions',
        events: sessionsEvents,
        // You can add default color/className for this source here if you want
    };

    const tasksSource = {
        id: 'tasks',
        events: tasksEvents,
        color: '#ffc107', // Fallback color if not set in event
        textColor: '#000' // Ensure text is readable on yellow
    };

    // --- Initialize Calendar ---
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: isMobile ? 'listWeek' : 'dayGridMonth',
        
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },

        height: 'auto',

        // Start with ONLY sessions by default (as per requirement)
        eventSources: [ sessionsSource ],

        eventClick: function(info) {
            info.jsEvent.preventDefault();
            const event = info.event;
            const props = event.extendedProps;

            // Handle Task Clicks (Redirect)
            if (props.type === 'task') {
                window.location.href = event.url;
                return;
            }

            // Handle Session Clicks (Modal)
            document.getElementById('modalTitle').textContent = `${props.school_group_name} Session`;
            document.getElementById('modalDate').textContent = new Date(event.startStr).toLocaleDateString();
            document.getElementById('modalTime').textContent = props.session_time_str;
            document.getElementById('modalVenue').textContent = props.venue_name;
            document.getElementById('modalCoaches').textContent = props.coaches_attending.join(', ');
            document.getElementById('modalStatus').textContent = props.status_display;

            document.getElementById('sessionPlanLink').href = event.url;
            
            const adminLink = document.getElementById('adminLink');
            if (adminLink) {
                adminLink.href = props.admin_url;
            }

            document.getElementById('sessionDetailModal').style.display = 'block';
        },
    });

    calendar.render();

    // --- Layer Toggling Logic ---
    const toggleSessions = document.getElementById('toggleSessions');
    const toggleTasks = document.getElementById('toggleTasks');

    if (toggleSessions) {
        toggleSessions.addEventListener('change', function() {
            if (this.checked) {
                calendar.addEventSource(sessionsSource);
            } else {
                const source = calendar.getEventSourceById('sessions');
                if (source) source.remove();
            }
        });
    }

    if (toggleTasks) {
        toggleTasks.addEventListener('change', function() {
            if (this.checked) {
                calendar.addEventSource(tasksSource);
            } else {
                const source = calendar.getEventSourceById('tasks');
                if (source) source.remove();
            }
        });
    }

    // Modal closing logic
    const modal = document.getElementById('sessionDetailModal');
    modal.querySelector('.close-button').onclick = () => modal.style.display = "none";
    window.onclick = (event) => {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    };
});
</script>
{% endblock %}
