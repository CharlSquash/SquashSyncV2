{% extends "base.html" %}
{% load static %}
{% load scheduling_extras %}

{% block title %}{{ page_title|default:"My Pending Assessments" }} - SquashSync{% endblock %}

{% block content %}
<style>
    /* Mobile-First Optimizations */
    .touch-target-min {
        min-width: 44px;
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    /* Segmented Control / Tabs */
    .assessment-tabs {
        display: flex;
        background-color: var(--container-light-bg);
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 20px;
    }
    .assessment-tab-btn {
        flex: 1;
        border: none;
        background: none;
        padding: 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--subheading-color);
        transition: all 0.2s;
    }
    .assessment-tab-btn.active {
        background-color: var(--container-bg);
        color: var(--link-color); /* Changed from 0d6efd to link-color for consistency */
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Star Rating Widget */
    .star-rating-widget {
        display: flex;
        flex-direction: row-reverse; /* Handle hover states correctly */
        justify-content: flex-end;
    }
    .star-rating-widget input {
        display: none;
    }
    .star-rating-widget label {
        color: var(--border-color); /* Empty star color */
        font-size: 1.5rem; /* Large stars */
        padding: 0 5px; /* Spacing */
        cursor: pointer;
        transition: color 0.2s;
        min-width: 30px; /* Touch target width */ 
        height: 44px;    /* Touch target height */
        display: inline-flex;
        align-items: center;
    }
    .star-rating-widget input:checked ~ label,
    .star-rating-widget label:hover,
    .star-rating-widget label:hover ~ label {
        color: #ffc107; /* Keep gold for stars, usually fine in dark mode too */
    }

    /* Assessment Row */
    .player-assessment-row {
        background: var(--container-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: border-color 0.3s;
    }
    .player-assessment-row.assessed {
        border-left: 5px solid #198754;
    }
    html.dark-mode .player-assessment-row.assessed {
        border-left-color: #20c997; /* Lighter green for dark mode */
    }

    .rating-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    .rating-label {
        font-size: 0.85rem;
        color: var(--subheading-color);
        font-weight: 500;
    }
    
    /* Notes Input */
    .auto-expand-input {
        width: 100%;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        border-radius: 6px;
        padding: 8px 12px;
        transition: all 0.3s;
    }
    .auto-expand-input:focus {
        border-color: var(--link-color);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); /* Could parameterize, but alpha is tricky. */
        min-height: 80px; /* Expand on focus */
    }

    /* Save Indicator */
    .save-status-indicator {
        opacity: 0;
        transition: opacity 0.5s;
        font-size: 0.8rem;
        color: #198754; /* Success green, usually ok */
        margin-left: 10px;
    }
    html.dark-mode .save-status-indicator {
        color: #20c997; /* Lighter green for dark mode */
    }
    .save-status-indicator.show {
        opacity: 1;
    }

    /* Match Form */
    .match-form-horizontal {
        background: var(--container-light-bg);
        padding: 15px;
        border-radius: 8px;
    }
</style>

<div class="container mt-4 mb-5">
    <div class="page-header mb-4">
        <h1><i class="bi bi-list-check me-2"></i>{{ page_title }}</h1>
    </div>

    {% if pending_items %}
        {% for item in pending_items %}
            <details class="pending-session-card" id="session-details-{{ item.session.id }}">
                <summary class="pending-session-header">
                    <div class="header-content">
                        <h3>
                            {% if item.is_marked_complete %}
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                            {% else %}
                                <i class="bi bi-hourglass-split text-muted me-2"></i>
                            {% endif %}
                            {{ item.session.session_date|date:"D, d M" }} - {{ item.session.school_group.name|default:"General" }}
                        </h3>
                        <p class="mb-0 text-muted small">
                            {{ item.session.session_start_time|time:"H:i" }} | {{ item.session.venue.name }}
                        </p>
                    </div>
                </summary>

                <div class="p-3">
                    <!-- Tab Navigation -->
                    <div class="assessment-tabs">
                        <button class="assessment-tab-btn active" onclick="switchTab('{{ item.session.id }}', 'players')" id="tab-btn-players-{{ item.session.id }}">Players</button>
                        <button class="assessment-tab-btn" onclick="switchTab('{{ item.session.id }}', 'group')" id="tab-btn-group-{{ item.session.id }}">Group</button>
                        <button class="assessment-tab-btn" onclick="switchTab('{{ item.session.id }}', 'matches')" id="tab-btn-matches-{{ item.session.id }}">Matches</button>
                    </div>

                    <!-- Players Tab -->
                    <div id="tab-content-players-{{ item.session.id }}" class="tab-content-pane">
                        {% if not item.attendance_taken %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i> 
                                <a href="{% url 'scheduling:visual_attendance' item.session.id %}?next=pending_assessments" class="alert-link">Take Attendance</a> first to assess players.
                            </div>
                        {% else %}
                             <!-- Quick Link to Attendance -->
                             <div class="text-end mb-3">
                                <a href="{% url 'scheduling:visual_attendance' item.session.id %}?next=pending_assessments" class="text-decoration-none small">
                                    <i class="bi bi-pencil-square"></i> Edit Attendance
                                </a>
                            </div>

                            <div class="player-list-container" id="player-list-{{ item.session.id }}">
                                {% for player in item.all_players_in_session %}
                                    {% with assessment_data=item.current_assessments|get_item:player.pk %}
                                    <div class="player-assessment-row {% if assessment_data.effort %}assessed{% endif %}" id="player-row-{{ player.pk }}">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0 fw-bold">{{ player.full_name }}</h5>
                                            <span class="save-status-indicator" id="save-indicator-{{ item.session.id }}-{{ player.pk }}">
                                                <i class="bi bi-check-lg"></i> Saved
                                            </span>
                                        </div>

                                        <!-- 5 Metrics -->
                                        {% for metric_key, metric_label in "effort:Effort,focus:Focus,resilience:Resilience,composure:Composure,decision:Decision Making"|split_metrics %}
                                        <div class="rating-group">
                                            <span class="rating-label">{{ metric_label }}</span>
                                            <div class="star-rating-widget">
                                                {% for i in "54321" %} <!-- Reverse order for CSS trick -->
                                                    <input type="radio" 
                                                           name="rating-{{ item.session.id }}-{{ player.pk }}-{{ metric_key }}" 
                                                           id="rating-{{ item.session.id }}-{{ player.pk }}-{{ metric_key }}-{{ i }}" 
                                                           value="{{ i }}"
                                                           {% if assessment_data|get_item:metric_key == i|add:"0" %}checked{% endif %}
                                                           onchange="saveAssessment('{{ item.session.id }}', '{{ player.pk }}', '{{ metric_key }}', this.value)">
                                                    <label for="rating-{{ item.session.id }}-{{ player.pk }}-{{ metric_key }}-{{ i }}" title="{{ i }} stars">â˜…</label>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}

                                        <!-- Notes -->
                                        <div class="mt-3">
                                            <input type="text" 
                                                   class="auto-expand-input" 
                                                   placeholder="Coach notes for {{ player.first_name }}..." 
                                                   value="{{ assessment_data.notes|default:'' }}"
                                                   onblur="saveAssessment('{{ item.session.id }}', '{{ player.pk }}', 'notes', this.value)"
                                                   onkeypress="if(event.key === 'Enter') this.blur();">
                                        </div>
                                    </div>
                                    {% endwith %}
                                {% empty %}
                                    <p class="text-muted text-center py-3">No players marked as attending.</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Group Tab -->
                    <div id="tab-content-group-{{ item.session.id }}" class="tab-content-pane" style="display:none;">
                        <div class="card card-body bg-light border-0">
                             {% load crispy_forms_tags %}
                             <form id="group-form-{{ item.session.id }}">
                                 {{ item.group_form|crispy }}
                                 <div class="d-flex align-items-center mt-3">
                                     <button type="button" class="btn btn-primary" onclick="saveGroupAssessment('{{ item.session.id }}')">
                                         Save Report
                                     </button>
                                     <span class="save-status-indicator" id="group-save-indicator-{{ item.session.id }}">
                                        <i class="bi bi-check-lg"></i> Saved
                                     </span>
                                 </div>
                             </form>
                         </div>
                    </div>

                    <!-- Matches Tab -->
                    <div id="tab-content-matches-{{ item.session.id }}" class="tab-content-pane" style="display:none;">
                        
                        {% if not item.attendance_taken %}
                             <div class="alert alert-secondary">Take attendance first to log matches.</div>
                        {% elif item.match_form.fields.player.queryset.count < 2 %}
                             <div class="alert alert-secondary">Need at least 2 players attending to log matches.</div>
                        {% else %}
                             <div class="match-form-horizontal mb-4">
                                <h6 class="mb-2 text-muted">Quick Add Result</h6>
                                <form action="{% url 'assessments:add_match_result' item.session.id %}" method="post">
                                    {% csrf_token %}
                                    <div class="input-group mb-2">
                                        {{ item.match_form.player }}
                                        <span class="input-group-text bg-white border-end-0">vs</span>
                                        {{ item.match_form.opponent }}
                                    </div>
                                    <div class="input-group">
                                        {{ item.match_form.player_score_str }}
                                        <span class="input-group-text">-</span>
                                        {{ item.match_form.opponent_score_str }}
                                        <button class="btn btn-primary" type="submit">Save</button>
                                    </div>
                                </form>
                             </div>
                        {% endif %}

                         <h6 class="mb-2">Session Results</h6>
                         <ul class="list-group list-group-flush">
                            {% for match in item.session_matches %}
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span>
                                        <strong>{{ match.player.last_name }}</strong> def. {{ match.opponent.last_name }}
                                        <span class="badge bg-light text-dark border ms-1">{{ match.player_score_str }}-{{ match.opponent_score_str }}</span>
                                    </span>
                                    <form action="{% url 'assessments:delete_match_result' match.id %}" method="post" onsubmit="return confirm('Delete?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-link text-danger p-0 ms-2"><i class="bi bi-x-circle-fill"></i></button>
                                    </form>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted ps-0">No matches recorded.</li>
                            {% endfor %}
                        </ul>
                    </div>

                </div>
            </details>
        {% endfor %}
    {% else %}
        <div class="no-pending-message">
             <p><i class="bi bi-check2-all"></i> All caught up!</p>
        </div>
    {% endif %}
</div>

<script>
    // --- Sticky State Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        const lastSessionId = localStorage.getItem('assesments_last_session_id');
        const lastTab = localStorage.getItem('assessments_last_tab') || 'players';

        // Initialize Sticky State
        if (lastSessionId) {
            const detailsEl = document.getElementById(`session-details-${lastSessionId}`);
            if (detailsEl) {
                detailsEl.open = true;
                setTimeout(() => detailsEl.scrollIntoView({behavior: 'smooth', block: 'start'}), 100);
            }
            switchTab(lastSessionId, lastTab);
        }

        // Add Toggle Listeners to all details elements
        document.querySelectorAll('details.pending-session-card').forEach(detail => {
            detail.addEventListener('toggle', function() {
                const sessionId = this.id.replace('session-details-', '');
                if (this.open) {
                    saveSessionState(sessionId);
                } else {
                    // Only clear if this is the currently stored one
                    if (localStorage.getItem('assesments_last_session_id') === sessionId) {
                        localStorage.removeItem('assesments_last_session_id');
                    }
                }
            });
        });
    });

    function saveSessionState(sessionId) {
        localStorage.setItem('assesments_last_session_id', sessionId);
        // Default to players tab if opening a new session
        const currentTab = localStorage.getItem('assessments_last_tab') || 'players';
        // Ensure UI matches
        switchTab(sessionId, currentTab);
    }

    function switchTab(sessionId, tabName) {
        // Save state
        localStorage.setItem('assessments_last_tab', tabName);
        localStorage.setItem('assesments_last_session_id', sessionId); // Ensure session is updated

        // Hide all contents for this session
        document.querySelector(`#tab-content-players-${sessionId}`).style.display = 'none';
        document.querySelector(`#tab-content-group-${sessionId}`).style.display = 'none';
        document.querySelector(`#tab-content-matches-${sessionId}`).style.display = 'none';
        
        // Remove active class from buttons
        document.querySelector(`#tab-btn-players-${sessionId}`).classList.remove('active');
        document.querySelector(`#tab-btn-group-${sessionId}`).classList.remove('active');
        document.querySelector(`#tab-btn-matches-${sessionId}`).classList.remove('active');

        // Show selected content
        document.querySelector(`#tab-content-${tabName}-${sessionId}`).style.display = 'block';
        document.querySelector(`#tab-btn-${tabName}-${sessionId}`).classList.add('active');
    }

    // --- Auto-Save AJAX Logic ---
    function saveGroupAssessment(sessionId) {
        const url = "{% url 'assessments:save_group_assessment_api' %}";
        const form = document.getElementById(`group-form-${sessionId}`);
        const indicator = document.getElementById(`group-save-indicator-${sessionId}`);
        
        // Form fields have a prefix 'group_{sessionId}-', so generic name won't work directly.
        // We can just grab the textarea since it's the only one, or valid by ID/Class if needed.
        const generalNotes = form.querySelector('textarea').value;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'session_id': sessionId,
                'general_notes': generalNotes
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                if (indicator) {
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 2000);
                }
                
                // If payment status changed, could reload, but let's keep it streamlined.
                if (data.marked_complete) {
                    // Update header icon if visual completeness matters immediately
                    // But maybe fine to leave as is until refresh.
                }
            } else {
                alert('Failed to save group report: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving.');
        });
    }

    function saveAssessment(sessionId, playerId, field, value) {
        const url = "{% url 'assessments:update_player_assessment_api' %}";
        const indicator = document.getElementById(`save-indicator-${sessionId}-${playerId}`);
        
        // Optimistic UI: Don't block user
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'session_id': sessionId,
                'player_id': playerId,
                'field': field,
                'value': value
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                // Show success feedback
                if (indicator) {
                    indicator.classList.add('show');
                    // Mark row as assessed visually (green border)
                    document.getElementById(`player-row-${playerId}`).classList.add('assessed');
                    
                    // Hide after 2 seconds
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 2000);
                }
                
                // Optional: Re-sort logic could go here, but might be jarring
            } else {
                console.error('Error saving assessment:', data.message);
                alert('Failed to save. Please check your connection.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving.');
        });
    }
</script>
{% endblock %}