{% extends "base.html" %}
{% load static %}
{% load scheduling_extras %}

{% block title %}{{ page_title|default:"My Pending Assessments" }} - SquashSync{% endblock %}

{% block content %}
<style>
    /* Mobile-First Optimizations */
    .touch-target-min {
        min-width: 44px;
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    /* Segmented Control / Tabs */
    .assessment-tabs {
        display: flex;
        background-color: var(--container-light-bg);
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 20px;
    }
    .assessment-tab-btn {
        flex: 1;
        border: none;
        background: none;
        padding: 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--subheading-color);
        transition: all 0.2s;
    }
    .assessment-tab-btn.active {
        background-color: var(--container-bg);
        color: var(--link-color); /* Changed from 0d6efd to link-color for consistency */
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Star Rating Widget */
    .star-rating-widget {
        display: flex;
        flex-direction: row-reverse; /* Handle hover states correctly */
        justify-content: flex-end;
    }
    .star-rating-widget input {
        display: none;
    }
    .star-rating-widget label {
        color: var(--border-color); /* Empty star color */
        font-size: 2rem; /* Large stars for mobile */
        padding: 0 5px; /* Spacing */
        cursor: pointer;
        transition: color 0.2s;
        min-width: 44px; /* Touch target width */ 
        height: 44px;    /* Touch target height */
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .star-rating-widget input:checked ~ label,
    .star-rating-widget label:hover,
    .star-rating-widget label:hover ~ label {
        color: #ffc107; /* Keep gold for stars, usually fine in dark mode too */
    }

    /* Assessment Row */
    .player-assessment-row {
        background: var(--container-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: border-color 0.3s;
    }
    .player-assessment-row.assessed {
        border-left: 5px solid #198754;
    }
    html.dark-mode .player-assessment-row.assessed {
        border-left-color: #20c997; /* Lighter green for dark mode */
    }

    .rating-group {
        display: flex;
        justify-content: space-between; /* Default for desktop */
        align-items: center;
        margin-bottom: 12px; /* Increased spacing */
        flex-wrap: wrap; /* Allow wrapping */
    }
    
    .rating-label {
        font-size: 0.9rem;
        color: var(--subheading-color);
        font-weight: 500;
        line-height: 1.2;
        margin-bottom: 0;
    }

    /* Mobile adjustments for rating group */
    @media (max-width: 500px) {
        .rating-group {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        .rating-label {
            max-width: 100%;
            margin-bottom: 2px;
        }
        .star-rating-widget {
            width: 100%;
            justify-content: space-between; /* Spread stars out slightly or keep right? */
            /* Actually, keeping them right or left? Let's try filling width or just large targets */
            justify-content: flex-start; /* Align left under text */
        }
        /* Make stars easier to hit */
        .star-rating-widget label {
            padding: 0 8px; 
            flex-grow: 1; /* evenly distribute touch targets */
            max-width: 60px; /* but don't get too wide */
        }
    }
    
    /* Notes Input */
    .auto-expand-input {
        width: 100%;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        border-radius: 6px;
        padding: 8px 12px;
        transition: all 0.3s;
    }
    .auto-expand-input:focus {
        border-color: var(--link-color);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); /* Could parameterize, but alpha is tricky. */
        min-height: 80px; /* Expand on focus */
    }

    /* Save Indicator */
    .save-status-indicator {
        opacity: 0;
        transition: opacity 0.5s;
        font-size: 0.8rem;
        color: #198754; /* Success green, usually ok */
        margin-left: 10px;
    }
    html.dark-mode .save-status-indicator {
        color: #20c997; /* Lighter green for dark mode */
    }
    .save-status-indicator.show {
        opacity: 1;
    }

    /* Match Form */
    .match-form-horizontal {
        background: var(--container-light-bg);
        padding: 15px;
        border-radius: 8px;
    }
    
    /* Star Key Legend */
    .star-key-legend {
        background-color: var(--subtle-bg);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
        font-size: 0.8rem;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        border: 1px solid var(--border-color);
    }
    .star-key-item {
        display: flex;
        align-items: center;
        gap: 4px;
        color: var(--text-muted);
        white-space: nowrap;
    }
    .star-key-item i {
        color: #ffc107;
        font-size: 0.9rem;
    }
</style>

<div class="container mt-4 mb-5">
    <div class="page-header mb-4">
        <h1><i class="bi bi-list-check me-2"></i>{{ page_title }}</h1>
    </div>

    {% if pending_items %}
        {% for item in pending_items %}
            <details class="pending-session-card" id="session-details-{{ item.session.id }}">
                <summary class="pending-session-header">
                    <div class="header-content">
                        <h3>
                            {% if item.is_marked_complete %}
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                            {% else %}
                                <i class="bi bi-hourglass-split text-muted me-2"></i>
                            {% endif %}
                            {{ item.session.session_date|date:"D, d M" }} - {{ item.session.school_group.name|default:"General" }}
                        </h3>
                        <p class="mb-0 text-muted small">
                            {{ item.session.session_start_time|time:"H:i" }} | {{ item.session.venue.name }}
                        </p>
                    </div>
                </summary>

                <div class="p-3">
                    <!-- Tab Navigation -->
                    <div class="assessment-tabs">
                        <button class="assessment-tab-btn active" onclick="switchTab('{{ item.session.id }}', 'players')" id="tab-btn-players-{{ item.session.id }}">Players</button>
                        <button class="assessment-tab-btn" onclick="switchTab('{{ item.session.id }}', 'group')" id="tab-btn-group-{{ item.session.id }}">Group</button>
                        <button class="assessment-tab-btn" onclick="switchTab('{{ item.session.id }}', 'matches')" id="tab-btn-matches-{{ item.session.id }}">Matches</button>
                    </div>

                    <!-- Players Tab -->
                    <div id="tab-content-players-{{ item.session.id }}" class="tab-content-pane">
                        {% if not item.attendance_taken %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i> 
                                <a href="{% url 'scheduling:visual_attendance' item.session.id %}?next=pending_assessments" class="alert-link">Click here to take attendance</a> first to assess players.
                            </div>
                        {% else %}
                             <!-- Quick Link to Attendance and Legend Toggle -->
                             <div class="d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#starKeyLegend-{{ item.session.id }}" aria-expanded="false" aria-controls="starKeyLegend-{{ item.session.id }}">
                                    <i class="bi bi-info-circle me-1"></i> Rating Key
                                </button>
                                <a href="{% url 'scheduling:visual_attendance' item.session.id %}?next=pending_assessments" class="text-decoration-none small">
                                    <i class="bi bi-pencil-square"></i> Edit Attendance
                                </a>
                            </div>

                            <!-- Star Key Legend (Collapsed by default) -->
                            <div class="collapse" id="starKeyLegend-{{ item.session.id }}">
                                <div class="star-key-legend">
                                    <span class="star-key-item"><i class="bi bi-star-fill"></i> 1: Needs Imp.</span>
                                    <span class="star-key-item"><i class="bi bi-star-fill"></i> 2: Below Avg</span>
                                    <span class="star-key-item"><i class="bi bi-star-fill"></i> 3: Adequate</span>
                                    <span class="star-key-item"><i class="bi bi-star-fill"></i> 4: Good</span>
                                    <span class="star-key-item"><i class="bi bi-star-fill"></i> 5: Excellent</span>
                                </div>
                            </div>

                            <div class="player-list-container" id="player-list-{{ item.session.id }}">
                                {% for player in item.all_players_in_session %}
                                    {% with assessment_data=item.current_assessments|get_item:player.pk %}
                                    <div class="player-assessment-row {% if assessment_data.effort_enthusiasm %}assessed{% endif %}" id="player-row-{{ player.pk }}">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0 fw-bold">{{ player.full_name }}</h5>
                                            <span class="save-status-indicator" id="save-indicator-{{ item.session.id }}-{{ player.pk }}">
                                                <i class="bi bi-check-lg"></i> Saved
                                            </span>
                                        </div>

                                        <!-- 5 Metrics -->
                                        {% for metric_key, metric_label in "effort_enthusiasm:Effort / Enthusiasm,skill_technique:Skill / Technique,sportsmanship_attitude:Sportsmanship / Attitude,tactical_mental:Tactical / Mental,fitness_perseverance:Fitness / Perseverance"|split_metrics %}
                                        <div class="rating-group">
                                            <span class="rating-label">{{ metric_label }}</span>
                                            <div class="star-rating-widget">
                                                {% for i in "54321" %} <!-- Reverse order for CSS trick -->
                                                    <input type="radio" 
                                                           name="rating-{{ item.session.id }}-{{ player.pk }}-{{ metric_key }}" 
                                                           id="rating-{{ item.session.id }}-{{ player.pk }}-{{ metric_key }}-{{ i }}" 
                                                           value="{{ i }}"
                                                           {% if assessment_data|get_item:metric_key == i|add:"0" %}checked{% endif %}
                                                           onchange="saveAssessment('{{ item.session.id }}', '{{ player.pk }}', '{{ metric_key }}', this.value)">
                                                    <label for="rating-{{ item.session.id }}-{{ player.pk }}-{{ metric_key }}-{{ i }}" title="{{ i }} stars">â˜…</label>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}

                                        <!-- Notes -->
                                        <div class="mt-3">
                                            <input type="text" 
                                                   class="auto-expand-input" 
                                                   placeholder="Coach notes for {{ player.first_name }}..." 
                                                   value="{{ assessment_data.notes|default:'' }}"
                                                   onblur="saveAssessment('{{ item.session.id }}', '{{ player.pk }}', 'notes', this.value)"
                                                   onkeypress="if(event.key === 'Enter') this.blur();">
                                        </div>
                                    </div>
                                    {% endwith %}
                                {% empty %}
                                    <p class="text-muted text-center py-3">No players marked as attending.</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Group Tab -->
                    <div id="tab-content-group-{{ item.session.id }}" class="tab-content-pane" style="display:none;">
                        <div class="card card-body border-0"> <!-- Removed bg-light for dark mode compatibility -->
                             {% load crispy_forms_tags %}
                             <form id="group-form-{{ item.session.id }}">
                                 {{ item.group_form|crispy }}
                                 <div class="d-flex align-items-center mt-3">
                                     <button type="button" class="btn btn-primary" onclick="saveGroupAssessment('{{ item.session.id }}')">
                                         Save Report
                                     </button>
                                     <span class="save-status-indicator" id="group-save-indicator-{{ item.session.id }}">
                                        <i class="bi bi-check-lg"></i> Saved
                                     </span>
                                 </div>
                             </form>
                         </div>
                    </div>

                    <!-- Matches Tab -->
                    <div id="tab-content-matches-{{ item.session.id }}" class="tab-content-pane" style="display:none;">
                        
                        {% if not item.attendance_taken %}
                             <div class="alert alert-secondary">Take attendance first to log matches.</div>
                        {% elif item.match_form.fields.player.queryset.count < 2 %}
                             <div class="alert alert-secondary">Need at least 2 players attending to log matches.</div>
                        {% else %}
                             <div class="match-form-horizontal mb-4">
                                <h6 class="mb-3 text-muted">Quick Add Result</h6>
                                <form id="match-form-{{ item.session.id }}" action="{% url 'assessments:add_match_result' item.session.id %}" method="post" onsubmit="submitMatchResult(event, '{{ item.session.id }}')">
                                    {% csrf_token %}
                                    
                                    <div class="row g-2 align-items-end">
                                        <!-- Winner Section -->
                                        <div class="col-5">
                                            <label class="form-label small text-success fw-bold mb-1">WINNER</label>
                                            {{ item.match_form.player }}
                                        </div>
                                        
                                        <div class="col-2 text-center pb-2">
                                            <span class="text-muted fw-bold">def.</span>
                                        </div>

                                        <!-- Loser Section -->
                                        <div class="col-5">
                                            <label class="form-label small text-muted fw-bold mb-1">LOSER</label>
                                            {{ item.match_form.opponent }}
                                        </div>
                                    </div>

                                    <div class="row g-2 align-items-center mt-2">
                                        <div class="col-12">
                                            <label class="form-label small text-muted mb-1">Score</label>
                                            <div class="input-group">
                                                {{ item.match_form.player_score_str }}
                                                <span class="input-group-text">-</span>
                                                {{ item.match_form.opponent_score_str }}
                                                <button class="btn btn-primary" type="submit">Save Result</button>
                                            </div>
                                            <div class="form-text small d-flex justify-content-between">
                                                <span>e.g. 11-9, 11-8, 11-5</span>
                                                <span class="save-status-indicator" id="match-save-indicator-{{ item.session.id }}">
                                                    <i class="bi bi-check-lg"></i> Saved
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                             </div>
                        {% endif %}

                         <h6 class="mb-2">Session Results</h6>
                         <ul class="list-group list-group-flush" id="match-list-{{ item.session.id }}">
                            {% for match in item.session_matches %}
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span>
                                        <strong>{{ match.player.last_name }}</strong> def. {{ match.opponent.last_name }}
                                        <span class="badge bg-light text-dark border ms-1">{{ match.player_score_str }}-{{ match.opponent_score_str }}</span>
                                    </span>
                                    <form action="{% url 'assessments:delete_match_result' match.id %}" method="post" onsubmit="return confirm('Delete?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-link text-danger p-0 ms-2"><i class="bi bi-x-circle-fill"></i></button>
                                    </form>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted ps-0">No matches recorded.</li>
                            {% endfor %}
                        </ul>
                    </div>

                </div>
            </details>
        {% endfor %}
    {% else %}
        <div class="no-pending-message">
             <p><i class="bi bi-check2-all"></i> All caught up!</p>
        </div>
    {% endif %}
</div>

<script>
    // --- Sticky State Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        const lastSessionId = localStorage.getItem('assesments_last_session_id');
        const lastTab = localStorage.getItem('assessments_last_tab') || 'players';

        // Initialize Sticky State
        if (lastSessionId) {
            const detailsEl = document.getElementById(`session-details-${lastSessionId}`);
            if (detailsEl) {
                detailsEl.open = true;
                setTimeout(() => detailsEl.scrollIntoView({behavior: 'smooth', block: 'start'}), 100);
            }
            switchTab(lastSessionId, lastTab);
        }

        // Add Toggle Listeners to all details elements
        document.querySelectorAll('details.pending-session-card').forEach(detail => {
            detail.addEventListener('toggle', function() {
                const sessionId = this.id.replace('session-details-', '');
                if (this.open) {
                    saveSessionState(sessionId);
                } else {
                    // Only clear if this is the currently stored one
                    if (localStorage.getItem('assesments_last_session_id') === sessionId) {
                        localStorage.removeItem('assesments_last_session_id');
                    }
                }
            });
        });
    });

    function saveSessionState(sessionId) {
        localStorage.setItem('assesments_last_session_id', sessionId);
        // Default to players tab if opening a new session
        const currentTab = localStorage.getItem('assessments_last_tab') || 'players';
        // Ensure UI matches
        switchTab(sessionId, currentTab);
    }

    function switchTab(sessionId, tabName) {
        // Save state
        localStorage.setItem('assessments_last_tab', tabName);
        localStorage.setItem('assesments_last_session_id', sessionId); // Ensure session is updated

        // Hide all contents for this session
        document.querySelector(`#tab-content-players-${sessionId}`).style.display = 'none';
        document.querySelector(`#tab-content-group-${sessionId}`).style.display = 'none';
        document.querySelector(`#tab-content-matches-${sessionId}`).style.display = 'none';
        
        // Remove active class from buttons
        document.querySelector(`#tab-btn-players-${sessionId}`).classList.remove('active');
        document.querySelector(`#tab-btn-group-${sessionId}`).classList.remove('active');
        document.querySelector(`#tab-btn-matches-${sessionId}`).classList.remove('active');

        // Show selected content
        document.querySelector(`#tab-content-${tabName}-${sessionId}`).style.display = 'block';
        document.querySelector(`#tab-btn-${tabName}-${sessionId}`).classList.add('active');
    }

    // --- Auto-Save AJAX Logic ---
    function saveGroupAssessment(sessionId) {
        const url = "{% url 'assessments:save_group_assessment_api' %}";
        const form = document.getElementById(`group-form-${sessionId}`);
        const indicator = document.getElementById(`group-save-indicator-${sessionId}`);
        
        // Form fields have a prefix 'group_{sessionId}-', so generic name won't work directly.
        // We can just grab the textarea since it's the only one, or valid by ID/Class if needed.
        const generalNotes = form.querySelector('textarea').value;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'session_id': sessionId,
                'general_notes': generalNotes
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                if (indicator) {
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 2000);
                }
                
                // If payment status changed, could reload, but let's keep it streamlined.
                if (data.marked_complete) {
                    // Update header icon if visual completeness matters immediately
                    // But maybe fine to leave as is until refresh.
                }
            } else {
                alert('Failed to save group report: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving.');
        });
    }

    function saveAssessment(sessionId, playerId, field, value) {
        const url = "{% url 'assessments:update_player_assessment_api' %}";
        const indicator = document.getElementById(`save-indicator-${sessionId}-${playerId}`);
        
        // Optimistic UI: Don't block user
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'session_id': sessionId,
                'player_id': playerId,
                'field': field,
                'value': value
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                // Show success feedback
                if (indicator) {
                    indicator.classList.add('show');
                    // Mark row as assessed visually (green border)
                    document.getElementById(`player-row-${playerId}`).classList.add('assessed');
                    
                    // Hide after 2 seconds
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 2000);
                }
                
                // Optional: Re-sort logic could go here, but might be jarring
            } else {
                console.error('Error saving assessment:', data.message);
                alert('Failed to save. Please check your connection.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving.');
        });
    }

    // --- Match Result AJAX Logic ---
    function submitMatchResult(event, sessionId) {
        event.preventDefault(); // Prevent default form submission
        
        const form = document.getElementById(`match-form-${sessionId}`);
        const url = form.action;
        const indicator = document.getElementById(`match-save-indicator-${sessionId}`);
        const formData = new FormData(form);
        
        // Add CSRF token manually (if not in FormData, though normally it is)
        
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 1. Show success indicator
                if (indicator) {
                    indicator.classList.add('show');
                    setTimeout(() => { indicator.classList.remove('show'); }, 2000);
                }
                
                // 2. Clear Score fields AND Dropdowns
                if(form.querySelector('[name="player_score_str"]')) form.querySelector('[name="player_score_str"]').value = '';
                if(form.querySelector('[name="opponent_score_str"]')) form.querySelector('[name="opponent_score_str"]').value = '';
                if(form.querySelector('[name="player"]')) form.querySelector('[name="player"]').value = '';
                if(form.querySelector('[name="opponent"]')) form.querySelector('[name="opponent"]').value = '';
                
                // 3. Append new match to list
                const list = document.getElementById(`match-list-${sessionId}`);
                // Remove "No matches recorded" if present
                const emptyItem = list.querySelector('.text-muted.ps-0');
                if (emptyItem && list.children.length === 1) {
                    emptyItem.remove();
                }

                const newItem = document.createElement('li');
                newItem.className = 'list-group-item d-flex justify-content-between align-items-center px-0';
                newItem.innerHTML = `
                    <span>
                        <strong>${data.match.winner_name}</strong> def. ${data.match.opponent_name}
                        <span class="badge bg-light text-dark border ms-1">${data.match.score_str}</span>
                    </span>
                    <form action="${data.match.delete_url}" method="post" onsubmit="return confirm('Delete?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-link text-danger p-0 ms-2"><i class="bi bi-x-circle-fill"></i></button>
                    </form>
                `;
                // Add as first item (or append, but usually new on top is better for immediate feedback, though backend sort is -id so top is correct)
                list.prepend(newItem);

                // 4. Focus back on input (optional, e.g. winner or score)
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving.');
        });
    }
</script>
{% endblock %}